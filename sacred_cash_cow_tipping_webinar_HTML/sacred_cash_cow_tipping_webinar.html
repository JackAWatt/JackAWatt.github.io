<!doctype html><html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>sacred cash cow tipping webinar</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="styles.css" type="text/css" />
</head>
<body><h1><b><u>sacred cash cow tipping webinar</u></b></h1><img src="images/20-1.png" alt="images/20-1.png" /><br /><br /><img src="images/20-2.png" alt="images/20-2.png" /><br /><br />copies of ruby / python can be found in x86/ prog files. Some apps will bring their own interpreter. it's possible these will be missed when locking down the box. This can get past application white listing. some legit tool might use these exe's. Restrict these when not needed. <br /><br />Inspect prog files and know what is there when lcoking down the system.<br /><br />restrict access to microsoft store<br /><br /><img src="images/20-3.png" alt="images/20-3.png" /><br /><br />it's more than looking at installed files. Must look at binaries that installed files also ship with. <br /><br /># config issue carbon black<br /><br /><img src="images/20-4.png" alt="images/20-4.png" /><br /><br />Was able to run powershell and download ps1 files. Due to bad config customer had<br /><br /><img src="images/20-5.png" alt="images/20-5.png" /><br /><br /><br /><img src="images/20-6.png" alt="images/20-6.png" /><br /><br />config was set up to look for ps1 files, but was able to run them from terminal<br /><br />#cisco AMP<br /><br /><img src="images/20-7.png" alt="images/20-7.png" /><br /><br />as tools get popular signatures are written, not when the tool gets released.<br /><br /><br /><img src="images/20-8.png" alt="images/20-8.png" /><br /><br />if attacker can get to command line, they can copy into 1 liners and run.<br /><br />older versions of powershell might be able to be uploaded and run, renaming might bypass sec products.<br /><br />#powershell AMSI bypass<br /><br /><img src="images/20-9.png" alt="images/20-9.png" /><br /><br />again, paste right into powershell session. <br /><br /><img src="images/20-10.png" alt="images/20-10.png" /><br /><br />again, misconfig. don't allow local users have admin.<br /><br /><img src="images/20-11.png" alt="images/20-11.png" /><br /><br />remaing cylance DLL.<br /><br /><img src="images/20-12.png" alt="images/20-12.png" /><br /><br />can then pull out user creds<br /><br /><img src="images/20-13.png" alt="images/20-13.png" /><br /><br /># defender and carbon black bypass:<br /><br /><img src="images/20-14.png" alt="images/20-14.png" /><br /><br /><img src="images/20-15.png" alt="images/20-15.png" /><br /><br />windows defender is hard to get past these days. MS has entered this game heavily<br /><br /><img src="images/20-16.png" alt="images/20-16.png" /><br /><br /><img src="images/20-17.png" alt="images/20-17.png" /><br /><br /><img src="images/20-18.png" alt="images/20-18.png" /><br /><br /># windows subsystem for linux<br /><br /><img src="images/20-19.png" alt="images/20-19.png" /><br /><br /><img src="images/20-20.png" alt="images/20-20.png" /><br /><br />it seems like this is a trusted process. <br /><br />drop the elf on the subsys on linux it works, but installing the metasploit in windows gets nuked by defender. <br /><br />will detect the ruby to gen the elf file, but not the elf file. <br /><br /><img src="images/20-21.png" alt="images/20-21.png" /><br /><br />everything in the sub system is ignored by the host system. <br /><br /><img src="images/20-22.png" alt="images/20-22.png" /><br /><br />microsoft store allows installing trusted programs. Good way to get python, etc. does not require admin. any user can do this, if the store isn't locked down. <br /><br /><img src="images/20-23.png" alt="images/20-23.png" /><br /><br /><img src="images/20-24.png" alt="images/20-24.png" /><br /><br />ignored because trusted, but establishes C2.<br /><br />python might not be a malicious app, but it can be used to write/run malicious code. <br /><br />- this is not an easter egg hunt. coming up with bypass techniques, a lot of times are config issues. vendors aren't fixing config issues(obviously). Education is needed, not action from vendor. <br /><br />this is not a disclosure issue like an exploit.<br /><br />audit and control of base systems is essential, not just running a tool.<br /><br /><img src="images/20-25.png" alt="images/20-25.png" /><br /><br />powershell is not dead. <br /><br />1: try to keep the scripts in memory<br />2: downgrade attacks still will work<br /><br />web cradles are still effective. <br />base64 encode, double encode can work to download. then decode it, then iex cradle to get into memory. <br /><br />a web cradle, create a system.net.webclient and then download into varialbe and iex to execute. <br /><br /><img src="images/20-26.png" alt="images/20-26.png" /><br /><br />if downgrade is not available. try to bypass some of the AMC hooks. <br /><br /><img src="images/20-27.png" alt="images/20-27.png" /><br /><br />can base64 encode to get scripts on system. <br /><br /><img src="images/20-28.png" alt="images/20-28.png" /><br /><br />download string can grab base64, then just need to decode.<br /><br /><img src="images/20-29.png" alt="images/20-29.png" /><br /><br /><img src="images/20-30.png" alt="images/20-30.png" /><br /><br />can compile custom .net assembly, and then call it from powershell cradle and invoke any namespace object.<br /><br /> <img src="images/20-31.png" alt="images/20-31.png" /><br /> <br /> create .net web client object in memory and then download over http. object created is native to system. <br /> can push through proxy this way. <br /> <br /> <img src="images/20-32.png" alt="images/20-32.png" /><br /> <br /> checkout deepblueCLI<br /> <br /> Prevent dropping down to previous powershell versions. not just deleting exes, but removing DLLs as well.<br /> <br /> # is there a good way to restrict access to powershell?<br /> <br /> blocking it isn't enough, renaming powershell to an allowed exe can work.<br /> <br /> whitelisting makes these things a lot more difficult than restricting access.<br /> <br /> <br /> # key takeaway:<br /> <br /> not one approach will work. <br /> <br /> Intent is more important than technique. <br /> <br /> <br /><br /><br /></body></html>